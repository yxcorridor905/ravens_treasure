<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raven's Treasure - ä¹Œé¸¦çš„å®è—</title>
    
    <!--
    ========================================
    ğŸ” å¼€å‘è€…é…ç½®è¯´æ˜
    ========================================
    
    æœ¬ç‰ˆæœ¬ä¸ºå¼€å‘è€…æ¨¡å¼ï¼š
    - API Key å·²ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
    - ç”¨æˆ·æ— æ³•é€šè¿‡ç•Œé¢ä¿®æ”¹ API Key
    - ç§»é™¤äº†æ‰€æœ‰ API è®¾ç½®ç›¸å…³çš„ç”¨æˆ·ç•Œé¢
    
    å¦‚éœ€é…ç½®æ‚¨çš„ DeepSeek API Keyï¼š
    1. åœ¨ä»£ç ä¸­æœç´¢ "âš ï¸ å¼€å‘è€…è¯·åœ¨æ­¤å¤„é…ç½®"
    2. å°† API Key æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å¯†é’¥
    3. æˆ–è€…æœç´¢ this.apiKey = 'sk-...'
    
    è·å– API Keyï¼šhttps://platform.deepseek.com
    ========================================
    -->
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Ma+Shan+Zheng&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* æ¡Œé¢ç«¯é¢„è§ˆå®¹å™¨ */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Serif SC', serif, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans SC", sans-serif;
        }

        /* æ‰‹æœºæ¨¡æ‹Ÿå™¨å¤–å£³ */
        @media (min-width: 768px) {
            body {
                background: linear-gradient(135deg, #8b7355 0%, #5a4a3a 100%);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                padding: 20px;
            }

            #phone-simulator {
                width: 375px;
                height: 812px;
                background: #000;
                border-radius: 40px;
                padding: 12px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                position: relative;
            }

            #phone-simulator::before {
                content: '';
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 150px;
                height: 30px;
                background: #000;
                border-radius: 0 0 20px 20px;
                z-index: 10;
            }

            #phone-screen {
                width: 100%;
                height: 100%;
                background: #E8E4D9;
                border-radius: 32px;
                overflow: hidden;
                position: relative;
            }
        }

        @media (max-width: 767px) {
            #phone-screen {
                width: 100%;
                min-height: 100vh;
                background: #E8E4D9;
            }
        }

        /* åº”ç”¨ä¸»ä½“ */
        #app {
            width: 100%;
            height: 100%;
            background: #E8E4D9;
            color: #3D2F2F;
            position: relative;
            overflow: hidden;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            visibility: hidden;
            opacity: 0;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: opacity 0.3s ease;
            padding-bottom: 103px;
        }

        @media (min-width: 768px) {
            .page {
                padding-bottom: 90px;
            }
        }

        .page.active {
            visibility: visible;
            opacity: 1;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .nav-bar {
            height: 88px;
            padding-top: 44px;
            background: #E8E4D9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-bottom: none;
        }

        .nav-bar .back-btn {
            position: absolute;
            left: 16px;
            top: 50px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3D2F2F;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 28px;
        }

        .nav-bar .title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #3D2F2F;
        }

        /* åº•éƒ¨TabBar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 83px;
            padding-bottom: 20px;
            background: #E8E4D9;
            border-top: 0.5px solid rgba(61, 47, 47, 0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-left: 20px;
            padding-right: 20px;
        }

        @media (min-width: 768px) {
            .tab-bar {
                max-width: 351px;
                left: auto;
                right: auto;
                bottom: 0;
                transform: none;
                border-radius: 0 0 20px 20px;
                margin: 0 12px 12px 12px;
                width: calc(100% - 24px);
                padding-bottom: 12px;
                height: 70px;
            }
            
            #phone-screen .tab-bar {
                position: absolute;
            }
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8b7355;
            font-size: 10px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 8px;
            letter-spacing: 0;
            transition: all 0.2s ease;
        }

        .tab-item.active {
            color: #3D2F2F;
        }

        .tab-item.active .tab-line {
            background: #3D2F2F;
        }

        .tab-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-icon svg {
            width: 26px;
            height: 26px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.2s ease;
        }

        .tab-item.active .tab-icon svg {
            stroke: #3D2F2F;
        }

        .tab-line {
            display: none;
        }

        /* ==================== è®°å½•é¡µ ==================== */
        #recordPage {
            display: flex;
            flex-direction: column;
        }

        .record-content {
            flex: 1;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
        }

        .page-icon {
            width: 64px;
            height: 64px;
            margin: 8px auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border-radius: 50%;
            animation: rotate-slow-icon 20s linear infinite; /* ç¼“æ…¢æ—‹è½¬ */
        }

        @keyframes rotate-slow-icon {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .page-icon svg {
            width: 48px;
            height: 48px;
            stroke: #8b7355;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .page-icon svg .fill-eye {
            fill: #8b7355;
        }

        .page-title {
            font-family: 'Ma Shan Zheng', 'Noto Serif SC', serif;
            font-size: 28px;
            font-weight: 400;
            text-align: center;
            margin-bottom: 12px;
            letter-spacing: 6px;
            color: #3D2F2F;
            /* åˆ é™¤æµ®åŠ¨åŠ¨æ•ˆ */
        }

        .page-subtitle {
            font-family: 'Noto Serif SC', serif;
            font-size: 12px;
            font-style: italic;
            text-align: center;
            margin-bottom: 36px;
            color: #8b7355;
            line-height: 1.8;
            opacity: 0.8;
        }

        .section-label {
            font-size: 13px;
            font-weight: 500;
            color: #3D2F2F;
            margin-bottom: 12px;
            letter-spacing: 0;
        }

        /* æƒ…ç»ªé€‰æ‹© */
        .emotion-selector {
            margin-bottom: 28px;
        }

        .emotion-list {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            cursor: grab;
        }

        .emotion-list::-webkit-scrollbar {
            display: none;
        }

        .emotion-btn {
            flex-shrink: 0;
            padding: 10px 16px;
            min-height: 40px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(61, 47, 47, 0.04);
            border: 1px solid rgba(61, 47, 47, 0.15);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: #3D2F2F;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            white-space: nowrap;
        }

        .emotion-btn .emotion-icon {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .emotion-btn.active {
            background: #3D2F2F;
            color: #E8E4D9;
            border-color: #3D2F2F;
            transform: scale(1.02);
        }

        .emotion-btn:active:not(.active) {
            transform: scale(0.96);
        }

        /* æƒ…ç»ªé¢œè‰² */
        .emotion-icon.èˆ’çˆ½ { background: #E8A95D; }
        .emotion-icon.æ˜åªš { background: #F4D06F; }
        .emotion-icon.çµæ„Ÿæ¶Œç° { background: #5B8C8A; }
        .emotion-icon.å¹³é™ { background: #7B9BA8; }
        .emotion-icon.è‡ªæˆ‘å®‰æŠš { background: #A0937D; }
        .emotion-icon.çƒ¦èº { background: #C77E6B; }
        .emotion-icon.ç„¦è™‘ { background: #9B7FA5; }
        .emotion-icon.è´Ÿé‡ { background: #6D6458; }
        .emotion-icon.æ„¤æ€’ { background: #A64B3A; }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            margin-bottom: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .text-input {
            width: 100%;
            flex: 1;
            min-height: 140px;
            padding: 14px;
            background: rgba(61, 47, 47, 0.03);
            border: 1px solid rgba(61, 47, 47, 0.1);
            border-radius: 12px;
            font-size: 15px;
            color: #3D2F2F;
            resize: none;
            font-family: inherit;
            line-height: 1.6;
            transition: all 0.2s ease;
        }

        .text-input::placeholder {
            color: rgba(139, 115, 85, 0.5);
        }

        .text-input:focus {
            outline: none;
            border-color: rgba(61, 47, 47, 0.25);
            background: rgba(61, 47, 47, 0.02);
        }

        /* ä¸»æŒ‰é’® */
        .primary-button {
            width: 100%;
            height: 50px;
            background: #C9A961;
            color: #3D2F2F;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
            position: relative;
            overflow: hidden;
        }

        .primary-button:disabled {
            background: rgba(61, 47, 47, 0.1);
            color: rgba(61, 47, 47, 0.3);
            cursor: not-allowed;
            box-shadow: none;
        }

        .primary-button:active:not(:disabled) {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(201, 169, 97, 0.3);
        }

        .primary-button.loading {
            position: relative;
            color: transparent;
        }

        .primary-button.loading::after {
            content: 'ç”Ÿæˆä¸­...';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #3D2F2F;
        }

        /* ==================== å®ç®±é¡µ ==================== */
        #treasureBoxPage {
            display: flex;
            flex-direction: column;
        }

        .treasure-box-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
        }

        .treasure-box-frame {
            width: 280px;
            height: 280px;
            border: 3px solid #3D2F2F;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            position: relative;
            background: #F5F2EA;
            padding: 20px;
        }

        .treasure-box-frame::before,
        .treasure-box-frame::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #3D2F2F;
        }

        .treasure-box-frame::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }

        .treasure-box-frame::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }

        .treasure-illustration {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .treasure-illustration svg {
            width: 200px;
            height: 200px;
            animation: float-chest 3s ease-in-out infinite; /* å®ç®±æµ®åŠ¨ */
        }

        /* å®ç®±æµ®åŠ¨åŠ¨ç”» */
        @keyframes float-chest {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }

        /* ä¸Šå‡å…‰ç‚¹ç²’å­æ•ˆæœ */
        .particles-rising {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle-rising {
            position: absolute;
            opacity: 0;
            animation: rise 4s ease-in infinite;
        }

        /* åœ†å½¢ç²’å­ */
        .particle-circle {
            width: 3px;
            height: 3px;
            border-radius: 50%;
        }

        /* é‡‘è‰²ç²’å­ */
        .particle-gold {
            background: #C9A961;
        }

        /* æ·±æ£•è‰²ç²’å­ */
        .particle-brown {
            background: #5D4E37;
        }

        /* å››è§’æ˜Ÿç²’å­ */
        .particle-star {
            width: 6px;
            height: 6px;
            background: transparent;
        }

        .particle-star::before,
        .particle-star::after {
            content: '';
            position: absolute;
            background: #C9A961;
        }

        .particle-star::before {
            width: 6px;
            height: 2px;
            top: 2px;
            left: 0;
        }

        .particle-star::after {
            width: 2px;
            height: 6px;
            top: 0;
            left: 2px;
        }

        /* ç¬¦æ–‡ç²’å­ */
        .particle-rune {
            width: 8px;
            height: 8px;
            font-size: 8px;
            color: #5D4E37;
            font-family: serif;
            line-height: 8px;
            text-align: center;
        }

        @keyframes rise {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-200px) scale(0.3);
                opacity: 0;
            }
        }

        /* åŠ¨æ€å®ç®± - ç›–å­åŠ¨ç”» */
        .chest-lid {
            transform-origin: 48px 120px; /* å·¦ä¾§é“°é“¾ä½ç½® */
            animation: lid-open-close 4s ease-in-out infinite;
        }

        @keyframes lid-open-close {
            0%, 100% {
                transform: rotate(0deg);
            }
            50% {
                transform: rotate(-15deg);
            }
        }

        .treasure-illustration svg .fill-box-body {
            fill: #D4C4A8;
            stroke: #8b7355;
        }

        .treasure-illustration svg .fill-box-lid {
            fill: #C9B896;
            stroke: #8b7355;
        }

        .treasure-illustration svg .fill-lock {
            fill: #C9A961;
            stroke: #8b7355;
        }

        .treasure-illustration svg .fill-magic-circle {
            fill: rgba(201, 169, 97, 0.15);
            stroke: #8b7355;
        }

        .treasure-illustration svg .decorative {
            stroke: #8b7355;
            stroke-width: 1.5;
        }

        .treasure-count {
            font-size: 13px;
            color: #8b7355;
            margin-top: 32px;
            letter-spacing: 1px;
        }

        .empty-state {
            text-align: center;
            color: #8b7355;
            font-size: 15px;
            margin-bottom: 32px;
            font-style: italic;
        }

        /* ==================== æŠ½å–é¡µ ==================== */
        #drawPage {
            display: flex;
            flex-direction: column;
        }

        .draw-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
        }

        .draw-animation {
            width: 280px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            position: relative;
        }

        /* å¤–åœˆ - æ…¢é€Ÿæ—‹è½¬ */
        .outer-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: spin-slow 8s linear infinite;
        }

        /* ä¸­åœˆ - ä¸­é€Ÿåå‘æ—‹è½¬ */
        .middle-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: spin-reverse 5s linear infinite;
        }

        /* å†…åœˆ - å¿«é€Ÿæ—‹è½¬ + è„‰åŠ¨ */
        .inner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: spin-fast 3s linear infinite, pulse 2s ease-in-out infinite;
        }

        /* ç¬¦æ–‡åœˆ - ä¸­é€Ÿæ—‹è½¬ */
        .rune-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: spin-medium 6s linear infinite;
        }

        /* ä¸­å¿ƒæ˜Ÿ - è„‰åŠ¨ + æ…¢é€Ÿæ—‹è½¬ */
        .center-star {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: spin-slow 10s linear infinite, pulse-star 3s ease-in-out infinite;
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes spin-medium {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes spin-fast {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes spin-reverse {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.08) rotate(180deg); }
        }

        @keyframes pulse-star {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.9; }
            50% { transform: scale(1.15) rotate(180deg); opacity: 1; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .draw-text {
            font-size: 15px;
            color: #8b7355;
            font-style: italic;
            text-align: center;
        }

        /* ==================== æˆ‘çš„é¡µ ==================== */
        #profilePage {
            display: flex;
            flex-direction: column;
        }

        .profile-content {
            flex: 1;
            padding: 20px 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(61, 47, 47, 0.2);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 12px;
            border: 2px solid rgba(61, 47, 47, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            position: relative;
        }

        .profile-avatar svg {
            width: 50px;
            height: 50px;
            stroke: #8b7355;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .profile-name {
            font-family: 'Noto Serif SC', serif;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #3D2F2F;
        }

        .profile-id {
            font-size: 12px;
            color: #8b7355;
            font-family: 'Courier New', monospace;
        }

        .stats-section {
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .stat-item {
            padding: 16px;
            background: #F5F2EA;
            border: 2px solid rgba(61, 47, 47, 0.15);
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-family: 'Noto Serif SC', serif;
            font-size: 28px;
            font-weight: 700;
            color: #C9A961;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #8b7355;
            letter-spacing: 0.5px;
        }

        .settings-section {
            margin-top: 20px;
        }

        .section-title {
            font-size: 12px;
            color: #8b7355;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 20px;
            height: 2px;
            background: #8b7355;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(212, 207, 195, 0.5);
            cursor: pointer;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b7355;
            font-size: 18px;
        }

        .setting-icon svg {
            width: 22px;
            height: 22px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .setting-label {
            font-size: 15px;
            color: #3D2F2F;
        }

        .setting-label.danger {
            color: #A64B3A;
        }

        .setting-arrow {
            color: #8b7355;
            font-size: 18px;
        }

        /* éŸ³é¢‘è®¾ç½®é¡¹ï¼ˆèƒŒæ™¯éŸ³ä¹ã€äº¤äº’éŸ³æ•ˆï¼‰ */
        .audio-setting-item {
            padding: 16px 0;
            border-bottom: 1px solid rgba(212, 207, 195, 0.5);
        }

        .audio-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            max-width: 200px;
        }

        .volume-icon-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: #8b7355;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .volume-icon-btn:hover {
            color: #C9A961;
            transform: scale(1.1);
        }

        .volume-icon-btn:active {
            transform: scale(0.95);
        }

        .volume-icon-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* é™éŸ³çŠ¶æ€ */
        .volume-icon-btn.muted svg path:nth-child(2),
        .volume-icon-btn.muted svg path:nth-child(3) {
            display: none;
        }

        .volume-slider-container {
            flex: 1;
            min-width: 80px;
        }

        .volume-value {
            font-size: 12px;
            color: #8b7355;
            min-width: 38px;
            text-align: right;
            flex-shrink: 0;
        }

        /* éŸ³é‡æ§åˆ¶ï¼ˆæ—§æ ·å¼ï¼Œä¿ç•™å…¼å®¹ï¼‰ */
        .volume-control {
            padding: 16px 0;
            border-bottom: 1px solid rgba(212, 207, 195, 0.5);
        }

        .volume-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #8b7355;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .volume-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(212, 207, 195, 0.3);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #C9A961;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #C9A961;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .volume-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        /* ==================== é®ç½©å’Œå¼¹çª— ==================== */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 500;
            animation: fadeIn 0.3s ease;
        }

        @media (min-width: 768px) {
            .overlay {
                position: absolute;
                border-radius: 32px;
            }
        }

        .overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* åˆ†äº«é¢æ¿é®ç½©å±‚ */
        .share-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 650;
            animation: fadeIn 0.3s ease;
        }

        @media (min-width: 768px) {
            .share-overlay {
                border-radius: 32px;
            }
        }

        .share-overlay.active {
            display: block;
        }

        /* å®è—é¢„è§ˆå¼¹çª— */
        .treasure-preview-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 340px;
            max-height: 85vh;
            overflow-y: auto;
            background: #E8E4D9;
            border: none;
            border-radius: 16px;
            padding: 40px 24px 24px;  /* å¢åŠ é¡¶éƒ¨ç•™ç™½ä»28pxåˆ°40px */
            z-index: 600;
            animation: scaleIn 0.4s ease;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        @media (min-width: 768px) {
            .treasure-preview-modal {
                max-width: 300px;
            }
        }

        .treasure-preview-modal.active {
            display: block;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #8b7355;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            line-height: 1;
        }

        .modal-close:active {
            color: #5a4a3a;
        }

        .preview-treasure-icon {
            width: 100px;  /* ä»200pxç¼©å°åˆ°100px */
            height: 100px;
            margin: 0 auto 24px;
            position: relative;
        }

        /* é­”æ³•é˜µå®¹å™¨ */
        .magic-circle-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* æ ·å¼1: ç»å…¸å…­èŠ’æ˜Ÿç¯ */
        .circle-classic .outer-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid #C9A961;
            border-radius: 50%;
            opacity: 0.8;
            animation: rotate 20s linear infinite;
        }

        .circle-classic .inner-ring {
            position: absolute;
            width: 85%;
            height: 85%;
            left: 7.5%;
            top: 7.5%;
            border: 2px solid #C9A961;
            border-radius: 50%;
            opacity: 0.6;
            animation: rotate-reverse 15s linear infinite;
        }

        .circle-classic .dots-container {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rotate 30s linear infinite;
        }

        .circle-classic .dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #C9A961;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(201, 169, 97, 0.6);
        }

        /* æ ·å¼2: ç¬¦æ–‡ä¸‰ç¯ */
        .circle-rune .ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid #C9A961;
            border-radius: 50%;
        }

        .circle-rune .ring-1 { 
            opacity: 0.8;
            animation: rotate 20s linear infinite;
        }
        .circle-rune .ring-2 { 
            width: 90%;
            height: 90%;
            left: 5%;
            top: 5%;
            opacity: 0.6;
            border-style: dashed;
            animation: rotate-reverse 25s linear infinite;
        }
        .circle-rune .ring-3 { 
            width: 75%;
            height: 75%;
            left: 12.5%;
            top: 12.5%;
            opacity: 0.4;
            animation: rotate 18s linear infinite;
        }

        .circle-rune .rune-container {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rotate 35s linear infinite;
        }

        .circle-rune .rune-symbol {
            position: absolute;
            font-size: 12px;  /* ä»14pxç¼©å°åˆ°12px */
            color: #C9A961;
            font-weight: bold;
            text-shadow: 0 0 6px rgba(201, 169, 97, 0.6);
        }

        /* æ ·å¼3: é˜´é˜³èºæ—‹ç¯ */
        .circle-spiral .spiral-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top-color: #C9A961;
            border-right-color: #C9A961;
            border-radius: 50%;
            opacity: 0.7;
            animation: rotate 20s linear infinite;
        }

        .circle-spiral .spiral-ring-2 {
            position: absolute;
            width: 85%;
            height: 85%;
            left: 7.5%;
            top: 7.5%;
            border: 3px solid transparent;
            border-left-color: #C9A961;
            border-bottom-color: #C9A961;
            border-radius: 50%;
            opacity: 0.5;
            animation: rotate-reverse 15s linear infinite;
        }

        /* æ ·å¼6: å¤æ–‡å°å°ç¯ */
        .circle-ancient .ancient-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px double #C9A961;
            border-radius: 50%;
            opacity: 0.7;
            animation: rotate 20s linear infinite;
        }

        .circle-ancient .inner-ancient {
            position: absolute;
            width: 80%;
            height: 80%;
            left: 10%;
            top: 10%;
            border: 2px solid #C9A961;
            border-radius: 50%;
            opacity: 0.5;
            animation: rotate-reverse 15s linear infinite;
        }

        .circle-ancient .ancient-container {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rotate 40s linear infinite;
        }

        .circle-ancient .ancient-symbol {
            position: absolute;
            font-size: 18px;
            color: #C9A961;
            font-family: serif;
            text-shadow: 0 0 8px rgba(201, 169, 97, 0.6);
        }

        /* ç²’å­å®¹å™¨ */
        .particles-container {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            z-index: 5;
            pointer-events: none;
        }

        /* å•ä¸ªç²’å­ */
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #C9A961;
            border-radius: 50%;
            left: 50%;
            top: 50%;
            opacity: 0;
            box-shadow: 0 0 4px rgba(201, 169, 97, 0.8);
        }

        /* ç²’å­å‘æ•£åŠ¨ç”» */
        @keyframes particle-burst {
            0% {
                transform: translate(-50%, -50%) translate(0, 0) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) translate(var(--tx), var(--ty)) scale(0.2);
                opacity: 0;
            }
        }

        /* å®è—SVGå›¾æ ‡ */
        .treasure-svg-icon {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            width: 60px;  /* ä»120pxç¼©å°åˆ°60px */
            height: 60px;
            filter: drop-shadow(0 2px 8px rgba(201, 169, 97, 0.4));
            /* animation: treasure-float 3s ease-in-out infinite; å·²ç§»é™¤æµ®åŠ¨ */
        }

        /* å®è—æµ®åŠ¨åŠ¨ç”» - ä»¥åœ†å¿ƒä¸ºåŸºå‡†ä¸Šä¸‹æµ®åŠ¨ */
        @keyframes treasure-float {
            0%, 100% {
                transform: translate(-50%, calc(-50% + 4px));  /* å‘ä¸‹4px */
            }
            50% {
                transform: translate(-50%, calc(-50% - 4px));  /* å‘ä¸Š4px */
            }
        }

        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes rotate-reverse {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }

        .preview-treasure-name {
            font-family: 'Noto Serif SC', serif;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 16px;
            color: #3D2F2F;
            letter-spacing: 1px;
        }

        .preview-treasure-content {
            font-size: 14px;
            line-height: 1.7;
            color: #3D2F2F;
            margin-bottom: 16px;
            padding: 14px;
            background: rgba(61, 47, 47, 0.03);
            border: 1px solid rgba(61, 47, 47, 0.08);
            border-radius: 10px;
            max-height: 140px;
            overflow-y: auto;
        }

        .preview-treasure-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(61, 47, 47, 0.08);
        }

        .preview-emotion-tag {
            padding: 6px 14px;
            color: #FFFFFF;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* æƒ…ç»ªtagé¢œè‰²ï¼ˆä½¿ç”¨emotion-iconçš„é¢œè‰²ä½œä¸ºèƒŒæ™¯ï¼‰ */
        .preview-emotion-tag .emotion-icon {
            display: none; /* éšè—å°åœ†ç‚¹ï¼Œåªç”¨æ–‡å­— */
        }
        
        /* æ ¹æ®æƒ…ç»ªè®¾ç½®preview-emotion-tagèƒŒæ™¯è‰² */
        .preview-emotion-tag:has(.emotion-icon.èˆ’çˆ½) { background: #E8A95D; }
        .preview-emotion-tag:has(.emotion-icon.æ˜åªš) { background: #F4D06F; color: #3D2F2F; } /* æ˜åªšç”¨æ·±è‰²æ–‡å­— */
        .preview-emotion-tag:has(.emotion-icon.çµæ„Ÿæ¶Œç°) { background: #5B8C8A; }
        .preview-emotion-tag:has(.emotion-icon.å¹³é™) { background: #7B9BA8; }
        .preview-emotion-tag:has(.emotion-icon.è‡ªæˆ‘å®‰æŠš) { background: #A0937D; }
        .preview-emotion-tag:has(.emotion-icon.çƒ¦èº) { background: #C77E6B; }
        .preview-emotion-tag:has(.emotion-icon.ç„¦è™‘) { background: #9B7FA5; }
        .preview-emotion-tag:has(.emotion-icon.è´Ÿé‡) { background: #6D6458; }
        .preview-emotion-tag:has(.emotion-icon.æ„¤æ€’) { background: #A64B3A; }

        .preview-treasure-time {
            font-size: 11px;
            color: #8b7355;
            font-family: 'Courier New', monospace;
            opacity: 0.8;
        }

        .preview-crow-comment {
            font-size: 13px;
            color: #8b7355;
            font-style: italic;
            text-align: center;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        .preview-actions {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 16px;
        }

        .preview-btn {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .preview-btn.save {
            background: #C9A961;
            color: #3D2F2F;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
        }

        .preview-btn.save:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(201, 169, 97, 0.3);
        }

        /* å®è—å¡å¼¹çª—ï¼ˆæŠ½å–åï¼‰ */
        .treasure-card-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 340px;
            max-height: 85vh;
            overflow-y: auto;
            background: #E8E4D9;
            border: none;
            border-radius: 16px;
            padding: 40px 24px 24px;  /* å¢åŠ é¡¶éƒ¨ç•™ç™½ä»28pxåˆ°40px */
            z-index: 600;
            animation: scaleIn 0.4s ease;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        @media (min-width: 768px) {
            .treasure-card-modal {
                max-width: 300px;
            }
        }

        .treasure-card-modal.active {
            display: block;
        }

        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(61, 47, 47, 0.06);
            border: none;
            border-radius: 18px;
            color: #3D2F2F;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .modal-close-btn:active {
            transform: scale(0.92);
            background: rgba(61, 47, 47, 0.1);
        }

        .modal-handle {
            display: none;
        }

        .treasure-card-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 24px;
            position: relative;
        }

        .treasure-card-name {
            font-family: 'Noto Serif SC', serif;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: #3D2F2F;
            letter-spacing: 2px;
        }

        .treasure-card-content {
            font-size: 15px;
            line-height: 1.8;
            color: #3D2F2F;
            margin: 20px 0;
            padding: 20px;
            background: #F5F2EA;
            border: 1px solid #D4CFC3;
            border-radius: 8px;
        }

        /* å®è—å¡åº•éƒ¨æ“ä½œå›¾æ ‡æ  */
        .treasure-card-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 32px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(61, 47, 47, 0.1);
        }

        /* å›¾æ ‡æŒ‰é’®é€šç”¨æ ·å¼ */
        .icon-btn {
            width: 44px;
            height: 44px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:active {
            transform: scale(0.9);
        }

        .icon-btn svg {
            width: 28px;
            height: 28px;
            stroke-width: 1.8;
            transition: all 0.3s ease;
        }

        /* æŠ½å–ç•Œé¢çš„æ›´å°å›¾æ ‡ */
        .treasure-card-actions:not(.preview-icons) .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        .treasure-card-actions:not(.preview-icons) {
            gap: 24px;
        }

        /* åˆ†äº«å›¾æ ‡ */
        .icon-btn.share-icon svg {
            stroke: #8b7355;
        }

        .icon-btn.share-icon:active svg {
            stroke: #5a4a3a;
        }

        /* ä¸‹è½½å›¾æ ‡ */
        .icon-btn.download-icon svg {
            stroke: #8b7355;
        }

        .icon-btn.download-icon:active svg {
            stroke: #5a4a3a;
        }

        /* åˆ é™¤å›¾æ ‡ */
        .icon-btn.delete-icon svg {
            stroke: #A64B3A;
        }

        .icon-btn.delete-icon:active svg {
            stroke: #8B3A2A;
        }

        /* å–æ¶ˆå›¾æ ‡ */
        .icon-btn.cancel-icon svg {
            stroke: #A64B3A;
        }

        .icon-btn.cancel-icon:active svg {
            stroke: #8B3A2A;
        }

        /* é¢„è§ˆç•Œé¢çš„å…³é—­æŒ‰é’®ä¼˜åŒ– */
        .preview-close-btn {
            width: 36px;
            height: 36px;
            background: rgba(166, 75, 58, 0.08);
            border-radius: 18px;
            font-size: 22px;
            color: #A64B3A;
            transition: all 0.2s ease;
        }

        .preview-close-btn:active {
            background: rgba(166, 75, 58, 0.15);
            color: #8B3A2A;
            transform: scale(0.92);
        }

        /* åˆ†äº«é¢æ¿ */
        .share-panel {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 300px;
            background: #E8E4D9;
            border-radius: 16px;
            padding: 28px 20px 24px;
            z-index: 700;
            animation: scaleIn 0.3s ease;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        @media (min-width: 768px) {
            .share-panel {
                max-width: 280px;
            }
        }

        .share-panel.active {
            display: block;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .share-panel-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: #3D2F2F;
            letter-spacing: 2px;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 18px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 12px 6px;
            border-radius: 10px;
            transition: all 0.2s ease;
            background: transparent;
        }

        .share-option:active {
            background: rgba(139, 115, 85, 0.08);
            transform: scale(0.95);
        }

        .share-option-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-option-icon svg {
            width: 40px;
            height: 40px;
        }

        .share-option-label {
            font-size: 11px;
            color: #5a4a3a;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .share-panel-close {
            width: 100%;
            height: 44px;
            background: transparent;
            border: 2px solid #3D2F2F;
            border-radius: 10px;
            color: #3D2F2F;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }

        .share-panel-close:active {
            background: rgba(61, 47, 47, 0.05);
            transform: scale(0.98);
        }

        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #E8E4D9;
            border: 3px solid #3D2F2F;
            border-radius: 8px;
            padding: 32px 24px;
            width: 85%;
            max-width: 300px;
            z-index: 700;
        }

        @media (min-width: 768px) {
            .confirm-dialog {
                position: absolute;
                max-width: 280px;
            }
        }

        .confirm-dialog.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .confirm-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
            color: #3D2F2F;
            letter-spacing: 2px;
        }

        .confirm-message {
            font-size: 14px;
            color: #5a4a3a;
            text-align: center;
            margin-bottom: 28px;
            white-space: pre-line;
            line-height: 1.6;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
        }

        .confirm-btn {
            flex: 1;
            height: 46px;
            border: 2px solid #3D2F2F;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 1px;
        }

        .confirm-btn.cancel {
            background: transparent;
            color: #3D2F2F;
        }

        .confirm-btn.confirm {
            background: #C9A961;
            color: #3D2F2F;
        }

        .confirm-btn.danger {
            background: #A64B3A;
            color: #E8E4D9;
        }

        /* Toastæç¤º */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 32px;
            background: rgba(61, 47, 47, 0.95);
            color: #E8E4D9;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: fadeInOut 2s ease;
            letter-spacing: 1px;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        /* AIè®¾ç½®æ ·å¼å·²ç§»é™¤ - å¼€å‘è€…æ¨¡å¼ */
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
        }

        .api-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 169, 97, 0.4);
        }

        .api-btn:active {
            transform: scale(0.98);
        }

        .ai-status {
            font-size: 16px;
            line-height: 1;
        }

        /* âœ…ä¿®å¤ï¼šè®©ç™¾åˆ†æ¯”é«˜åº¦åœ¨æ‰‹æœºä¸Šæœ‰"å‚ç…§ç‰©" */
        html, body {
            height: 100%;
        }

        /* âœ…ä¿®å¤ï¼šæ‰‹æœºç«¯ç»™ phone-screen ä¸€ä¸ªæ˜ç¡® heightï¼ˆä¸è¦åªç”¨ min-heightï¼‰ */
        @media (max-width: 767px) {
            #phone-screen {
                height: 100vh;      /* å…³é”® */
                min-height: 100vh;  /* ä½ åŸæœ¬å°±æœ‰ï¼Œä¿ç•™ä¹Ÿè¡Œ */
            }
            #app {
                height: 100%;
                min-height: 100vh;
                position: relative; /* è®©ç»å¯¹å®šä½çš„ page æœ‰å‚ç…§ */
            }
        }

        /* ç«èŠ±å››å°„ç‚¹å‡»æ•ˆæœ */
        .spark {
            position: absolute;
            width: 3px;
            height: 12px;
            background: linear-gradient(to bottom, #F4D06F, #E8A95D);
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes spark-fly {
            0% {
                transform: translate(0, 0) rotate(var(--rotation)) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--rotation)) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="phone-simulator">
        <div id="phone-screen">
            <div id="app">
                <!-- è®°å½•é¡µ -->
                <div id="recordPage" class="page active">
                    <div class="nav-bar">
                        <div class="title">è®°å½•æƒ³æ³•</div>
                    </div>

                    <div class="record-content">
                        <div class="page-icon">
                            <svg viewBox="0 0 48 48">
                                <!-- å¤–åœ† -->
                                <circle cx="24" cy="24" r="20" />
                                <!-- å…­èŠ’æ˜Ÿ - ä¸Šä¸‰è§’ -->
                                <path d="M 24 8 L 38 32 L 10 32 Z" />
                                <!-- å…­èŠ’æ˜Ÿ - ä¸‹ä¸‰è§’ -->
                                <path d="M 24 40 L 10 16 L 38 16 Z" />
                                <!-- å†…åœ† -->
                                <circle cx="24" cy="24" r="8" />
                                <!-- è£…é¥°å°åœ†ç‚¹ -->
                                <circle cx="24" cy="4" r="1.5" class="fill-eye" />
                                <circle cx="41.5" cy="14" r="1.5" class="fill-eye" />
                                <circle cx="41.5" cy="34" r="1.5" class="fill-eye" />
                                <circle cx="24" cy="44" r="1.5" class="fill-eye" />
                                <circle cx="6.5" cy="34" r="1.5" class="fill-eye" />
                                <circle cx="6.5" cy="14" r="1.5" class="fill-eye" />
                            </svg>
                        </div>
                        <div class="page-title">ä¹Œé¸¦çš„å®è—</div>
                        <div class="page-subtitle">"å°†æƒ…ç»ªæ”¶è—äºæ—¶å…‰çš„å®ç®±ï¼Œ<br>å¾…å¾€åå²æœˆæ…¢æ…¢å¯å°ã€‚"</div>

                        <div class="emotion-selector">
                            <div class="section-label">ä»Šæ—¥æºæ¥ä½•ç‰©ï¼Ÿ</div>
                            <div class="emotion-list" id="emotionList"></div>
                        </div>

                        <div class="input-area">
                            <div class="section-label">é“­åˆ»æ­¤åˆ»å¿ƒç»ª</div>
                            <textarea class="text-input" id="contentInput" placeholder="å†™ä¸‹ä½ æƒ³è®°ä½çš„..."></textarea>
                        </div>

                        <button class="primary-button" id="generateBtn" disabled>ç”Ÿæˆå®è—</button>
                    </div>
                </div>

                <!-- å®ç®±é¡µ -->
                <div id="treasureBoxPage" class="page">
                    <div class="nav-bar">
                        <div class="title">å®ç®±</div>
                    </div>

                    <div class="treasure-box-content" id="treasureBoxContent"></div>
                </div>

                <!-- æŠ½å–é¡µ -->
                <div id="drawPage" class="page">
                    <div class="nav-bar">
                        <button class="back-btn" onclick="showPage('treasureBox')">â†</button>
                        <div class="title">æŠ½å–ä¸­</div>
                    </div>

                    <div class="draw-content">
                        <div class="draw-animation">
                            <!-- å¤–åœˆ - æ…¢é€Ÿæ—‹è½¬ -->
                            <svg class="outer-ring" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="140" cy="140" r="135" fill="none" stroke="#C9A961" stroke-width="2"/>
                                <circle cx="140" cy="140" r="125" fill="none" stroke="#C9A961" stroke-width="1" stroke-dasharray="8,8"/>
                                
                                <!-- å››ä¸ªæ–¹ä½çš„è£…é¥°ç¬¦å· -->
                                <text x="140" y="20" font-size="18" fill="#C9A961" text-anchor="middle">âœ¦</text>
                                <text x="260" y="145" font-size="18" fill="#C9A961" text-anchor="middle">âœ¦</text>
                                <text x="140" y="270" font-size="18" fill="#C9A961" text-anchor="middle">âœ¦</text>
                                <text x="20" y="145" font-size="18" fill="#C9A961" text-anchor="middle">âœ¦</text>
                            </svg>

                            <!-- ç¬¦æ–‡åœˆ - ä¸­é€Ÿæ—‹è½¬ -->
                            <svg class="rune-ring" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="140" cy="140" r="107" fill="none" stroke="#5D4E37" stroke-width="1.5"/>
                                
                                <!-- å…«ä¸ªæ–¹ä½çš„ç¬¦æ–‡ -->
                                <text x="140" y="45" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">áš±</text>
                                <text x="199" y="81" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">áš¨</text>
                                <text x="233" y="145" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">áš¹</text>
                                <text x="199" y="209" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">á›–</text>
                                <text x="140" y="245" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">áš¾</text>
                                <text x="81" y="209" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">á›</text>
                                <text x="47" y="145" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">áš±</text>
                                <text x="81" y="81" font-size="22" fill="#5D4E37" text-anchor="middle" font-family="serif">á›–</text>
                            </svg>

                            <!-- ä¸­åœˆ - ä¸­é€Ÿåå‘æ—‹è½¬ -->
                            <svg class="middle-ring" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="140" cy="140" r="93" fill="none" stroke="#C9A961" stroke-width="2"/>
                                <circle cx="140" cy="140" r="84" fill="none" stroke="#5D4E37" stroke-width="1" stroke-dasharray="5,5"/>
                                
                                <!-- å…­ä¸ªå°åœ†ç‚¹ -->
                                <circle cx="140" cy="47" r="4" fill="#C9A961"/>
                                <circle cx="221" cy="99" r="4" fill="#C9A961"/>
                                <circle cx="221" cy="181" r="4" fill="#C9A961"/>
                                <circle cx="140" cy="233" r="4" fill="#C9A961"/>
                                <circle cx="59" cy="181" r="4" fill="#C9A961"/>
                                <circle cx="59" cy="99" r="4" fill="#C9A961"/>
                            </svg>

                            <!-- å†…åœˆ - å¿«é€Ÿæ—‹è½¬ + è„‰åŠ¨ -->
                            <svg class="inner-ring" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="140" cy="140" r="70" fill="none" stroke="#5D4E37" stroke-width="2"/>
                                <circle cx="140" cy="140" r="61" fill="none" stroke="#C9A961" stroke-width="1" stroke-dasharray="4,4"/>
                            </svg>

                            <!-- ä¸­å¿ƒå…­èŠ’æ˜Ÿ - è„‰åŠ¨ + æ…¢é€Ÿæ—‹è½¬ -->
                            <svg class="center-star" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
                                <!-- æ ‡å‡†å…­èŠ’æ˜Ÿ -->
                                <!-- ä¸Šä¸‰è§’ -->
                                <path d="M 140 84 L 188 168 L 92 168 Z" 
                                      fill="none" stroke="#C9A961" stroke-width="3"/>
                                
                                <!-- ä¸‹ä¸‰è§’ -->
                                <path d="M 140 196 L 92 112 L 188 112 Z" 
                                      fill="none" stroke="#C9A961" stroke-width="3"/>
                                
                                <!-- å†…éƒ¨æ­£å…­è¾¹å½¢ -->
                                <path d="M 140 116 L 161 127 L 161 153 L 140 164 L 119 153 L 119 127 Z" 
                                      fill="none" stroke="#5D4E37" stroke-width="2"/>
                                
                                <!-- å…­ä¸ªäº¤ç‚¹çš„å°åœ† -->
                                <circle cx="140" cy="116" r="3.5" fill="#C9A961"/>
                                <circle cx="161" cy="127" r="3.5" fill="#C9A961"/>
                                <circle cx="161" cy="153" r="3.5" fill="#C9A961"/>
                                <circle cx="140" cy="164" r="3.5" fill="#C9A961"/>
                                <circle cx="119" cy="153" r="3.5" fill="#C9A961"/>
                                <circle cx="119" cy="127" r="3.5" fill="#C9A961"/>
                                
                                <!-- ä¸­å¿ƒåœ† -->
                                <circle cx="140" cy="140" r="19" fill="none" stroke="#5D4E37" stroke-width="2"/>
                                <circle cx="140" cy="140" r="11" fill="#C9A961" opacity="0.6"/>
                                <circle cx="140" cy="140" r="6" fill="#5D4E37"/>
                            </svg>
                        </div>
                        <div class="draw-text">çœ‹çœ‹è¿™æ¬¡ä¼šè·å–ä»€ä¹ˆã€‚</div>
                    </div>
                </div>

                <!-- æˆ‘çš„é¡µ -->
                <div id="profilePage" class="page">
                    <div class="nav-bar">
                        <div class="title">æˆ‘çš„</div>
                    </div>

                    <div class="profile-content">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <svg viewBox="0 0 48 48">
                                    <circle cx="24" cy="18" r="10" />
                                    <path d="M 8 42 Q 8 30 24 30 Q 40 30 40 42" />
                                </svg>
                            </div>
                            <div class="profile-name">æ¼«å®¢æ—…äºº</div>
                            <div class="profile-id">ç¼–å·ï¼š@guest</div>
                        </div>

                        <div class="stats-section">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value" id="profileTreasureCount">0</div>
                                    <div class="stat-label">å®è—æ€»æ•°</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="profileRecordDays">0</div>
                                    <div class="stat-label">è®°å½•å¤©æ•°</div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <!-- èƒŒæ™¯éŸ³ä¹ -->
                            <div class="audio-setting-item">
                                <div class="audio-header">
                                    <div class="setting-left">
                                        <div class="setting-icon">
                                            <svg viewBox="0 0 24 24">
                                                <path d="M9 18V5l12-2v13" />
                                                <circle cx="6" cy="18" r="3" />
                                                <circle cx="18" cy="16" r="3" />
                                            </svg>
                                        </div>
                                        <div class="setting-label">èƒŒæ™¯éŸ³ä¹</div>
                                    </div>
                                    <div class="audio-controls">
                                        <button class="volume-icon-btn" onclick="toggleMusic()" id="musicIconBtn">
                                            <svg viewBox="0 0 24 24" id="musicVolumeIcon">
                                                <!-- å–‡å­ -->
                                                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                                <!-- éŸ³æ³¢ -->
                                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                                            </svg>
                                        </button>
                                        <div class="volume-slider-container">
                                            <input type="range" id="volumeSlider" min="0" max="100" value="30" class="volume-slider" oninput="updateVolume(this.value)">
                                        </div>
                                        <span class="volume-value" id="volumeValue">30%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- äº¤äº’éŸ³æ•ˆ -->
                            <div class="audio-setting-item">
                                <div class="audio-header">
                                    <div class="setting-left">
                                        <div class="setting-icon">
                                            <svg viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="12" y1="8" x2="12" y2="12"/>
                                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                                            </svg>
                                        </div>
                                        <div class="setting-label">äº¤äº’éŸ³æ•ˆ</div>
                                    </div>
                                    <div class="audio-controls">
                                        <button class="volume-icon-btn" onclick="toggleSFX()" id="sfxIconBtn">
                                            <svg viewBox="0 0 24 24" id="sfxVolumeIcon">
                                                <!-- å–‡å­ -->
                                                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                                <!-- éŸ³æ³¢ -->
                                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                                            </svg>
                                        </button>
                                        <div class="volume-slider-container">
                                            <input type="range" id="sfxVolumeSlider" min="0" max="100" value="100" class="volume-slider" oninput="updateSFXVolume(this.value)">
                                        </div>
                                        <span class="volume-value" id="sfxVolumeValue">100%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AIè®¾ç½®å·²ç§»é™¤ - å¼€å‘è€…æ¨¡å¼ -->
                            
                            <div class="setting-item" onclick="showAbout()">
                                <div class="setting-left">
                                    <div class="setting-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                                            <line x1="10" y1="10" x2="16" y2="10" />
                                            <line x1="10" y1="14" x2="16" y2="14" />
                                        </svg>
                                    </div>
                                    <div class="setting-label">ä½¿ç”¨æ‰‹å†Œ</div>
                                </div>
                                <div class="setting-arrow">â†’</div>
                            </div>

                            <div class="setting-item" onclick="confirmClearAll()">
                                <div class="setting-left">
                                    <div class="setting-icon">
                                        <svg viewBox="0 0 24 24">
                                            <polyline points="3 6 5 6 21 6" />
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                            <line x1="10" y1="11" x2="10" y2="17" />
                                            <line x1="14" y1="11" x2="14" y2="17" />
                                        </svg>
                                    </div>
                                    <div class="setting-label danger">æ¸…ç©ºæ‰€æœ‰å®è—</div>
                                </div>
                                <div class="setting-arrow">â†’</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨TabBar -->
                <div class="tab-bar">
                    <button class="tab-item active" onclick="showPage('record')">
                        <div class="tab-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 20h9" />
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                            </svg>
                        </div>
                        <div>è®°å½•</div>
                        <div class="tab-line"></div>
                    </button>
                    <button class="tab-item" onclick="showPage('treasureBox')">
                        <div class="tab-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                                <line x1="12" y1="22.08" x2="12" y2="12" />
                            </svg>
                        </div>
                        <div>å®ç®±</div>
                        <div class="tab-line"></div>
                    </button>
                    <button class="tab-item" onclick="showPage('profile')">
                        <div class="tab-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </div>
                        <div>æˆ‘çš„</div>
                        <div class="tab-line"></div>
                    </button>
                </div>

                <!-- é®ç½©å±‚ -->
                <div class="overlay" id="overlay" onclick="closeModal()"></div>

                <!-- å®è—é¢„è§ˆå¼¹çª— -->
                <div class="treasure-preview-modal" id="treasurePreviewModal"></div>

                <!-- å®è—å¡å¼¹çª— -->
                <div class="treasure-card-modal" id="treasureCardModal"></div>

                <!-- ç¡®è®¤å¯¹è¯æ¡† -->
                <div class="confirm-dialog" id="confirmDialog"></div>
                
                <!-- åˆ†äº«é¢æ¿é®ç½©å±‚ -->
                <div class="share-overlay" id="shareOverlay" onclick="closeSharePanel()"></div>
                
                <!-- åˆ†äº«é¢æ¿ -->
                <div class="share-panel" id="sharePanel">
                    <div class="share-panel-title">åˆ†äº«å®è—</div>
                    <div class="share-options">
                        <div class="share-option" onclick="shareToWechat()">
                            <div class="share-option-icon">
                                <svg viewBox="0 0 24 24" fill="none">
                                    <!-- å¾®ä¿¡logoï¼šä¸¤ä¸ªå¯¹è¯æ°”æ³¡é è¿‘æœ‰äº¤é›† -->
                                    <ellipse cx="7.5" cy="9.5" rx="4.5" ry="4" fill="#8b7355"/>
                                    <ellipse cx="15" cy="14" rx="4" ry="3.3" fill="#8b7355"/>
                                    <circle cx="6" cy="9" r="1" fill="white"/>
                                    <circle cx="9" cy="9" r="1" fill="white"/>
                                    <circle cx="13.5" cy="13.5" r="0.8" fill="white"/>
                                    <circle cx="16.5" cy="13.5" r="0.8" fill="white"/>
                                </svg>
                            </div>
                            <div class="share-option-label">å¾®ä¿¡</div>
                        </div>
                        <div class="share-option" onclick="shareToXiaohongshu()">
                            <div class="share-option-icon">
                                <svg viewBox="0 0 24 24" fill="none">
                                    <!-- å°çº¢ä¹¦logoï¼šåœ†è§’æ–¹å½¢+å°å­— -->
                                    <rect x="4" y="4" width="16" height="16" rx="3" fill="#8b7355"/>
                                    <text x="12" y="13.5" text-anchor="middle" 
                                          font-size="4" font-weight="bold" fill="white" 
                                          letter-spacing="0.2">å°çº¢ä¹¦</text>
                                </svg>
                            </div>
                            <div class="share-option-label">å°çº¢ä¹¦</div>
                        </div>
                        <div class="share-option" onclick="shareToQQ()">
                            <div class="share-option-icon">
                                <svg viewBox="0 0 24 24" fill="none">
                                    <!-- QQ logoï¼šä¼é¹…å¤´èº«é è¿‘ -->
                                    <ellipse cx="12" cy="9" rx="4.2" ry="3.5" fill="#8b7355"/>
                                    <ellipse cx="12" cy="15" rx="5.5" ry="5.5" fill="#8b7355"/>
                                    <ellipse cx="12" cy="15.5" rx="3.2" ry="3.8" fill="white"/>
                                    <circle cx="10" cy="8.5" r="1.2" fill="white"/>
                                    <circle cx="14" cy="8.5" r="1.2" fill="white"/>
                                    <circle cx="10" cy="8.5" r="0.6" fill="#5a4a3a"/>
                                    <circle cx="14" cy="8.5" r="0.6" fill="#5a4a3a"/>
                                    <ellipse cx="12" cy="11.5" rx="2.5" ry="1.3" fill="#C9A961"/>
                                    <ellipse cx="9" cy="20.5" rx="1.5" ry="0.8" fill="#C9A961"/>
                                    <ellipse cx="15" cy="20.5" rx="1.5" ry="0.8" fill="#C9A961"/>
                                </svg>
                            </div>
                            <div class="share-option-label">QQ</div>
                        </div>
                    </div>
                    <button class="share-panel-close" onclick="closeSharePanel()">å–æ¶ˆ</button>
                </div>
                
                <!-- API Keyå¯¹è¯æ¡†å·²ç§»é™¤ - å¼€å‘è€…æ¨¡å¼ -->
            </div>
        </div>
    </div>

    <script>
        // ==================== AIå¢å¼ºé…ç½® ====================
        
        // AIé…ç½®
        const AI_CONFIG = {
            provider: 'deepseek',
            // âœ… ç”Ÿäº§ç¯å¢ƒï¼šé€šè¿‡ Netlify Functions ä»£ç†è°ƒç”¨ï¼ˆé¿å…åœ¨å‰ç«¯æš´éœ² API Keyï¼‰
            // ï¼ˆnetlify.toml å·²æŠŠ /api/treasure è½¬å‘åˆ° /.netlify/functions/treasureï¼‰
            endpoint: '/api/treasure',
            model: 'deepseek-chat',
            maxTokens: 200,
            temperature: 0.8,
            timeout: 8000 // 8ç§’è¶…æ—¶
        };
        
        // AI System Prompt
        const AI_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€åªç¥ç§˜çš„ä¹Œé¸¦ï¼Œè´Ÿè´£ä¸ºç”¨æˆ·çš„æƒ…ç»ªè®°å½•èµ‹äºˆå®è—ä¹‹åã€‚

è§’è‰²è®¾å®šï¼š
- ä½ æ˜¯å¤è€è€Œæ™ºæ…§çš„å®ˆæŠ¤è€…
- ä½ çš„è¯­è¨€ç®€æ´ã€å……æ»¡è¯—æ„å’Œå“²ç†
- ä½ å–„äºå‘ç°å¹³å‡¡ä¸­çš„çè´µä¹‹å¤„

ä»»åŠ¡ï¼š
1. æ ¹æ®ç”¨æˆ·çš„æƒ…ç»ªå’Œå†…å®¹ï¼Œåˆ›é€ ä¸€ä¸ªç‹¬ç‰¹çš„å®è—åç§°ï¼ˆ4-7ä¸ªå­—ï¼‰
2. å†™ä¸€å¥ä¹Œé¸¦ç‚¹è¯„ï¼ˆ15-30å­—ï¼‰ï¼Œç»™äºˆæ¸©æš–çš„é¼“åŠ±æˆ–æ·±åˆ»çš„æ´å¯Ÿ

å®è—åç§°è¦æ±‚ï¼š
- å¯Œæœ‰è¯—æ„å’Œè±¡å¾æ„ä¹‰
- ä¸æƒ…ç»ªå’Œå†…å®¹ç›¸å…³
- å¯ä»¥æ˜¯ç‰©å“ã€è‡ªç„¶ç°è±¡ã€æˆ–æŠ½è±¡æ¦‚å¿µ
- ç¤ºä¾‹ï¼šæ™¨å…‰é‡‘å¸ã€é™æ°´æŠ¤ç¬¦ã€æ€ç»ªä¹‹ç“¶ã€ç ´æ™“è€…çš„å¾½ç« ã€å›å“çš„é“ƒé“›

ç‚¹è¯„è¦æ±‚ï¼š
- æ¸©æš–ã€é¼“åŠ±ã€æœ‰æ´å¯ŸåŠ›
- ç®€çŸ­æœ‰åŠ›ï¼Œåƒä¸€å¥ç®´è¨€
- é¿å…é™ˆè¯æ»¥è°ƒ
- ç¬¬äºŒäººç§°å™è¿°ï¼ˆ"ä½ "ï¼‰
- ä¸è¦ä½¿ç”¨"åŠ æ²¹"ç­‰å£å·å¼çš„è¯

æƒ…ç»ªç±»å‹è¯´æ˜ï¼š
- èˆ’çˆ½ï¼šå®ŒæˆæŒ‘æˆ˜ã€è¾¾æˆç›®æ ‡ã€å…‹æœå›°éš¾åçš„è½»æ¾æ„‰æ‚¦
- æ˜åªšï¼šå•çº¯çš„å¿«ä¹ã€ç¾å¥½çš„ä½“éªŒã€æ¸©æš–çš„æ—¶åˆ»
- çµæ„Ÿæ¶Œç°ï¼šåˆ›æ„è¿¸å‘ã€æ€ç»´æ´»è·ƒã€æ–°æƒ³æ³•äº§ç”Ÿ
- å¹³é™ï¼šå†…å¿ƒå®‰å®ã€æ”¾æ¾ã€ä¸è‡ªå·±å’Œè§£
- è‡ªæˆ‘å®‰æŠšï¼šç»™äºˆè‡ªå·±å…³æ€€ã€æ¥çº³æƒ…ç»ªã€æ¸©æŸ”å¯¹å¾…è‡ªå·±
- çƒ¦èºï¼šè½»åº¦ç„¦è™‘ã€ä¸è€çƒ¦ã€è¢«çäº‹å›°æ‰°
- ç„¦è™‘ï¼šæ‹…å¿§ã€ä¸å®‰ã€å¯¹æœªæ¥çš„ææƒ§
- è´Ÿé‡ï¼šå‹åŠ›ã€è´£ä»»ã€ç–²æƒ«ã€æ²‰é‡æ„Ÿ
- æ„¤æ€’ï¼šæ„¤æ…¨ã€ä¸å…¬ã€è¢«å†’çŠ¯ã€å¼ºçƒˆæƒ…ç»ª

å›å¤æ ¼å¼ï¼ˆå¿…é¡»æ˜¯çº¯JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼‰ï¼š
{
  "treasure_name": "å®è—åç§°",
  "crow_comment": "ä¹Œé¸¦ç‚¹è¯„"
}`;
        
        // AIç”¨æˆ·Promptç”Ÿæˆå‡½æ•°
        function generateUserPrompt(emotion, content) {
            return `æƒ…ç»ªï¼š${emotion}
è®°å½•å†…å®¹ï¼š${content}

è¯·ä¸ºè¿™æ®µè®°å½•åˆ›é€ ä¸€ä¸ªå®è—åç§°ï¼Œå¹¶ç»™å‡ºä½ çš„ç‚¹è¯„ã€‚è®°ä½è¦ç”¨çº¯JSONæ ¼å¼å›å¤ã€‚`;
        }
        
        // AIæœåŠ¡ç±»
        class AITreasureService {
            constructor() {
                // âœ… ç”Ÿäº§ç¯å¢ƒï¼šAPI Key ä¸å†æ”¾åœ¨å‰ç«¯ã€‚ç”± Netlify Functions è¯»å–ç¯å¢ƒå˜é‡å¹¶ä»£ä¸ºè¯·æ±‚ã€‚
                // å‰ç«¯åªéœ€è¦è°ƒç”¨æœ¬ç½‘ç«™çš„ /.netlify/functions/treasure
                
                this.isOnline = navigator.onLine;
                this.lastRequestTime = 0;
                this.minRequestInterval = 1000; // æœ€å°è¯·æ±‚é—´éš”1ç§’
                this.requestCount = 0;
                this.maxRequestsPerMinute = 30;
                this.requestTimes = [];
                
                // ç›‘å¬ç½‘ç»œçŠ¶æ€
                window.addEventListener('online', () => {
                    this.isOnline = true;
                });
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });
            }
            
            // æ£€æµ‹API Keyæ˜¯å¦é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼šKey åœ¨æœåŠ¡å™¨ä¾§ï¼Œè¿™é‡Œåªè¦è”ç½‘å³å¯ï¼‰
            hasAPIKey() {
                return true;
            }
            
            // è·å–å½“å‰æ¨¡å¼
            getCurrentMode() {
                if (!this.hasAPIKey()) return 'local';
                if (!this.isOnline) return 'offline';
                return 'ai';
            }
            
            // é€Ÿç‡é™åˆ¶æ£€æŸ¥
            canMakeRequest() {
                const now = Date.now();
                
                // æ£€æŸ¥æœ€å°é—´éš”
                if (now - this.lastRequestTime < this.minRequestInterval) {
                    return false;
                }
                
                // æ£€æŸ¥æ¯åˆ†é’Ÿè¯·æ±‚æ•°
                this.requestTimes = this.requestTimes.filter(time => now - time < 60000);
                if (this.requestTimes.length >= this.maxRequestsPerMinute) {
                    return false;
                }
                
                return true;
            }
            
            // è®°å½•è¯·æ±‚
            recordRequest() {
                const now = Date.now();
                this.lastRequestTime = now;
                this.requestTimes.push(now);
            }
            
            // ä¸»è¦ç”Ÿæˆå‡½æ•°
            async generateTreasure(emotion, content) {
                console.log('ğŸ¯ å¼€å§‹ç”Ÿæˆå®è—:', { emotion, content });
                console.log('ğŸŒ ç½‘ç»œçŠ¶æ€:', this.isOnline);
                
                // 1. æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨AI
                if (!this.isOnline || !this.hasAPIKey()) {
                    console.log('ğŸ“š ä½¿ç”¨æœ¬åœ°æ¨¡å¼ - åŸå› :', !this.isOnline ? 'ç½‘ç»œç¦»çº¿' : 'API Keyæœªé…ç½®');
                    return this.generateLocalTreasure(emotion);
                }
                
                // 2. é€Ÿç‡é™åˆ¶æ£€æŸ¥
                if (!this.canMakeRequest()) {
                    console.log('â±ï¸ è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                    return this.generateLocalTreasure(emotion);
                }
                
                try {
                    console.log('ğŸ¤– å°è¯•ä½¿ç”¨AIç”Ÿæˆ...');
                    
                    // 3. è°ƒç”¨AI API
                    const result = await this.callDeepSeekAPI(emotion, content);
                    
                    // 4. éªŒè¯ç»“æœ
                    if (this.validateAIResponse(result)) {
                        console.log('âœ¨ AIç”ŸæˆæˆåŠŸ');
                        this.recordRequest();
                        return {
                            ...result,
                            source: 'ai',
                            emotion: emotion
                        };
                    } else {
                        throw new Error('AIå“åº”æ ¼å¼æ— æ•ˆ');
                    }
                    
                } catch (error) {
                    console.warn('AIç”Ÿæˆå¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°æ¨¡å¼:', error.message);
                    return this.generateLocalTreasure(emotion);
                }
            }
            
            // è°ƒç”¨DeepSeek API
            async callDeepSeekAPI(emotion, content) {
                console.log('ğŸ“¡ æ­£åœ¨è°ƒç”¨DeepSeek API...');
                console.log('ğŸ”— Endpoint:', AI_CONFIG.endpoint);
                console.log('ğŸ¤– Model:', AI_CONFIG.model);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), AI_CONFIG.timeout);
                
                try {
                    // âœ… å‰ç«¯åªæŠŠå¿…è¦ä¿¡æ¯å‘ç»™æœ¬ç«™çš„ Function
                    const requestBody = {
                        emotion,
                        content,
                        model: AI_CONFIG.model,
                        maxTokens: AI_CONFIG.maxTokens,
                        temperature: AI_CONFIG.temperature
                    };

                    const response = await fetch(AI_CONFIG.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('âŒ APIé”™è¯¯å“åº”:', errorData);
                        throw new Error(`APIé”™è¯¯ ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                    }
                    
                    const data = await response.json();
                    console.log('âœ… APIå“åº”æˆåŠŸ:', data);
                    
                    // âœ… Function å·²è¿”å›æ ‡å‡† JSONï¼š{ treasure_name, crow_comment }
                    if (!data || typeof data.treasure_name !== 'string') {
                        console.error('âŒ Functionå“åº”æ ¼å¼å¼‚å¸¸:', data);
                        throw new Error('Functionå“åº”æ ¼å¼å¼‚å¸¸');
                    }
                    return data;
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    if (error.name === 'AbortError') {
                        throw new Error('è¯·æ±‚è¶…æ—¶');
                    }
                    
                    throw error;
                }
            }
            
            // éªŒè¯AIå“åº”
            validateAIResponse(result) {
                return result 
                    && typeof result.treasure_name === 'string' 
                    && result.treasure_name.length >= 3
                    && result.treasure_name.length <= 20
                    && typeof result.crow_comment === 'string'
                    && result.crow_comment.length >= 10
                    && result.crow_comment.length <= 80;
            }
            
            // æœ¬åœ°é™çº§ç”Ÿæˆ
            generateLocalTreasure(emotion) {
                const treasures = TREASURE_MAP[emotion] || TREASURE_MAP['èˆ’çˆ½'];
                const treasure = treasures[Math.floor(Math.random() * treasures.length)];
                
                const comment = getRavenComment(emotion);
                
                return {
                    treasure_name: treasure,
                    crow_comment: comment,
                    emotion: emotion,
                    source: 'local'
                };
            }
            
            // æµ‹è¯•APIè¿æ¥
            async testConnection() {
                if (!this.hasAPIKey()) {
                    return { success: false, message: 'è¯·å…ˆè¾“å…¥API Key' };
                }
                
                if (!this.isOnline) {
                    return { success: false, message: 'ç½‘ç»œæœªè¿æ¥' };
                }
                
                try {
                    const result = await this.callDeepSeekAPI('å¹³é™', 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•');
                    
                    if (this.validateAIResponse(result)) {
                        return { 
                            success: true, 
                            message: 'è¿æ¥æˆåŠŸï¼',
                            sample: result
                        };
                    } else {
                        return { success: false, message: 'APIå“åº”æ ¼å¼å¼‚å¸¸' };
                    }
                } catch (error) {
                    return { 
                        success: false, 
                        message: `è¿æ¥å¤±è´¥: ${error.message}` 
                    };
                }
            }
        }
        
        // åˆ›å»ºå…¨å±€AIæœåŠ¡å®ä¾‹
        const aiService = new AITreasureService();
        
        // ğŸ”§ å¼€å‘è€…è°ƒè¯•å·¥å…· - å¯åœ¨æµè§ˆå™¨æ§åˆ¶å°è°ƒç”¨
        window.testAI = async function() {
            console.log('\n=== ğŸ§ª AIåŠŸèƒ½è¯Šæ–­æµ‹è¯• ===');
            console.log('1ï¸âƒ£ API KeyçŠ¶æ€:', aiService.hasAPIKey() ? 'âœ“ å·²é…ç½®' : 'âœ— æœªé…ç½®');
            console.log('2ï¸âƒ£ ç½‘ç»œçŠ¶æ€:', aiService.isOnline ? 'âœ“ åœ¨çº¿' : 'âœ— ç¦»çº¿');
            console.log('3ï¸âƒ£ å½“å‰æ¨¡å¼:', aiService.getCurrentMode());
            console.log('4ï¸âƒ£ APIé…ç½®:', AI_CONFIG);
            
            console.log('\nå¼€å§‹æµ‹è¯•APIè°ƒç”¨...');
            try {
                const result = await aiService.generateTreasure('æ˜åªš', 'ä»Šå¤©é˜³å…‰å¾ˆå¥½ï¼Œå¿ƒæƒ…æ„‰æ‚¦');
                console.log('âœ… æµ‹è¯•æˆåŠŸï¼ç”Ÿæˆç»“æœ:', result);
                return result;
            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                return null;
            }
        };
        
        console.log('ğŸ’¡ å¼€å‘è€…æç¤ºï¼šåœ¨æ§åˆ¶å°è¾“å…¥ testAI() å¯æµ‹è¯•AIåŠŸèƒ½');
        
        // ==================== éŸ³é¢‘ç³»ç»Ÿ ====================
        
        const AudioSystem = {
            context: null,
            bgMusic: null,
            isMuted: false,
            musicInterval: null,
            masterVolume: 0.3, // é»˜è®¤éŸ³é‡30%
            sfxVolume: 1.0, // äº¤äº’éŸ³æ•ˆéŸ³é‡ï¼Œé»˜è®¤100%
            isFirstPlay: true, // æ ‡è®°æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ’­æ”¾
            
            init() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
                this.createRelaxingCelticMusic();
            },
            
            // éŸ³ç¬¦é¢‘ç‡è¡¨
            noteFreqs: {
                C4: 261.63, D4: 293.66, F4: 349.23, A4: 440.00, B4: 493.88, C5: 523.25, G4: 392.00
            },
            
            // åˆ›å»ºæ”¾æ¾çš„å‡¯å°”ç‰¹é£æ ¼éŸ³ä¹ï¼ˆæ¨¡ä»¿Relaxing Green Natureï¼‰
            createRelaxingCelticMusic() {
                if (!this.context) return;
                
                // å’Œå¼¦è¿›è¡Œ (Då°è°ƒï¼Œæ”¾æ¾æŸ”å’Œ)
                const chordProgression = [
                    { root: 146.83, notes: [146.83, 174.61, 220.00] }, // Dm
                    { root: 130.81, notes: [130.81, 164.81, 196.00] }, // C
                    { root: 116.54, notes: [116.54, 146.83, 174.61] }, // Bb
                    { root: 196.00, notes: [196.00, 246.94, 293.66] }, // G
                    { root: 146.83, notes: [146.83, 174.61, 220.00] }, // Dm
                    { root: 174.61, notes: [174.61, 220.00, 261.63] }, // F
                    { root: 130.81, notes: [130.81, 164.81, 196.00] }, // C
                    { root: 146.83, notes: [146.83, 174.61, 220.00] }, // Dm
                ];
                
                // ä¸»æ—‹å¾‹ï¼ˆç«–ç´é£æ ¼ï¼‰
                const melodySequence = [
                    { freq: 293.66, duration: 1.0 },   // D4
                    { freq: 329.63, duration: 0.5 },   // E4
                    { freq: 349.23, duration: 0.5 },   // F4
                    { freq: 392.00, duration: 1.5 },   // G4
                    { freq: 349.23, duration: 0.5 },   // F4
                    { freq: 329.63, duration: 0.5 },   // E4
                    { freq: 293.66, duration: 1.0 },   // D4
                    { freq: 261.63, duration: 0.5 },   // C4
                    { freq: 293.66, duration: 2.0 },   // D4
                    { freq: 220.00, duration: 0.5 },   // A3
                    { freq: 246.94, duration: 0.5 },   // B3
                    { freq: 293.66, duration: 1.0 },   // D4
                    { freq: 349.23, duration: 1.5 },   // F4
                    { freq: 329.63, duration: 0.5 },   // E4
                    { freq: 293.66, duration: 2.0 },   // D4
                ];
                
                let melodyIndex = 0;
                let chordIndex = 0;
                let isPlaying = false;
                
                const playMusic = () => {
                    if (this.isMuted || !this.context) {
                        this.musicInterval = setTimeout(playMusic, 100);
                        return;
                    }
                    
                    const now = this.context.currentTime;
                    const melody = melodySequence[melodyIndex];
                    
                    // ç¬¬ä¸€ä¸ªéŸ³ç¬¦æ·¡å…¥500msï¼ˆæ›´é•¿ï¼Œé¿å…è½°é¸£ï¼‰ï¼Œå…¶ä»–50ms
                    const fadeInTime = (melodyIndex === 0) ? 0.5 : 0.05;
                    
                    // æ’­æ”¾å’Œå¼¦ï¼ˆå‰ä»–/ç«–ç´ä¼´å¥ï¼‰
                    const chord = chordProgression[chordIndex];
                    chord.notes.forEach((freq, i) => {
                        const osc = this.context.createOscillator();
                        const gain = this.context.createGain();
                        
                        osc.type = 'sine'; // ç«–ç´éŸ³è‰²
                        osc.frequency.setValueAtTime(freq, now);
                        
                        const volume = 0.054 * AudioSystem.masterVolume;
                        const startTime = now + i * 0.05;
                        
                        gain.gain.setValueAtTime(0.001, startTime);
                        gain.gain.linearRampToValueAtTime(volume, startTime + fadeInTime);
                        gain.gain.setValueAtTime(volume, now + melody.duration - 0.05);
                        gain.gain.linearRampToValueAtTime(0.001, now + melody.duration);
                        
                        osc.connect(gain);
                        gain.connect(this.context.destination);
                        
                        osc.start(startTime);
                        osc.stop(now + melody.duration + 0.1);
                    });
                    
                    // æ’­æ”¾ä¸»æ—‹å¾‹
                    const melOsc = this.context.createOscillator();
                    const melGain = this.context.createGain();
                    
                    melOsc.type = 'triangle'; // æŸ”å’Œçš„æ—‹å¾‹éŸ³è‰²
                    melOsc.frequency.setValueAtTime(melody.freq, now);
                    
                    const melVolume = 0.081 * AudioSystem.masterVolume;
                    
                    melGain.gain.setValueAtTime(0.001, now);
                    melGain.gain.linearRampToValueAtTime(melVolume, now + fadeInTime);
                    melGain.gain.setValueAtTime(melVolume, now + melody.duration - 0.05);
                    melGain.gain.linearRampToValueAtTime(0.001, now + melody.duration);
                    
                    melOsc.connect(melGain);
                    melGain.connect(this.context.destination);
                    
                    melOsc.start(now);
                    melOsc.stop(now + melody.duration + 0.1);
                    
                    // æ’­æ”¾ä½éŸ³ï¼ˆè´æ–¯ï¼‰
                    const bass = this.context.createOscillator();
                    const bassGain = this.context.createGain();
                    
                    bass.type = 'sine';
                    bass.frequency.setValueAtTime(chord.root * 0.5, now);
                    
                    const bassVolume = 0.0675 * AudioSystem.masterVolume;
                    
                    bassGain.gain.setValueAtTime(0.001, now);
                    bassGain.gain.linearRampToValueAtTime(bassVolume, now + fadeInTime);
                    bassGain.gain.setValueAtTime(bassVolume, now + melody.duration - 0.05);
                    bassGain.gain.linearRampToValueAtTime(0.001, now + melody.duration);
                    
                    bass.connect(bassGain);
                    bassGain.connect(this.context.destination);
                    
                    bass.start(now);
                    bass.stop(now + melody.duration + 0.1);
                    
                    melodyIndex = (melodyIndex + 1) % melodySequence.length;
                    
                    // æ¯4ä¸ªæ—‹å¾‹éŸ³ç¬¦æ¢ä¸€ä¸ªå’Œå¼¦
                    if (melodyIndex % 4 === 0) {
                        chordIndex = (chordIndex + 1) % chordProgression.length;
                    }
                    
                    this.musicInterval = setTimeout(playMusic, melody.duration * 1000);
                };
                
                this.bgMusic = {
                    play: async () => {
                        if (!isPlaying) {
                            isPlaying = true;
                            // é‡ç½®éŸ³ä¹ç´¢å¼•ï¼Œä»å¤´å¼€å§‹æ’­æ”¾
                            melodyIndex = 0;
                            chordIndex = 0;
                            
                            // ç¬¬ä¸€æ¬¡æ’­æ”¾æ—¶ï¼Œç­‰å¾…AudioContextå®Œå…¨ç¨³å®š
                            if (AudioSystem.isFirstPlay) {
                                await new Promise(resolve => setTimeout(resolve, 50));
                            }
                            
                            playMusic();
                        }
                    },
                    stop: () => {
                        isPlaying = false;
                        if (this.musicInterval) {
                            clearTimeout(this.musicInterval);
                        }
                    }
                };
            },
            
            // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            async playBGMusic() {
                if (this.bgMusic && !this.isMuted) {
                    // ç¡®ä¿AudioContextå·²æ¢å¤ï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½å¯åŠ¨ï¼‰
                    if (this.context.state === 'suspended') {
                        await this.context.resume();
                    }
                    
                    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ’­æ”¾ï¼Œæ·»åŠ çŸ­æš‚å»¶è¿Ÿè®©contextå®Œå…¨å‡†å¤‡å¥½
                    if (this.isFirstPlay) {
                        this.isFirstPlay = false;
                        // ç­‰å¾…100msè®©AudioContextå®Œå…¨åˆå§‹åŒ–
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    this.bgMusic.play();
                }
            },
            
            // åˆ‡æ¢é™éŸ³
            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.isMuted && this.bgMusic) {
                    this.bgMusic.stop();
                } else if (!this.isMuted && this.bgMusic) {
                    this.bgMusic.play();
                }
                return this.isMuted;
            },
            
            // è®¾ç½®éŸ³é‡
            setVolume(value) {
                this.masterVolume = value;
                // æ›´æ–°æ˜¾ç¤º
                const volumeValue = document.getElementById('volumeValue');
                if (volumeValue) {
                    volumeValue.textContent = Math.round(value * 100) + '%';
                }
            },
            
            // è·å–å½“å‰éŸ³é‡
            getVolume() {
                return this.masterVolume || 1.0;
            },
            
            // === ç¡®è®¤çš„éŸ³æ•ˆ ===
            
            // 1. å¢å¼ºé»‘è½´ç‚¹å‡»éŸ³æ•ˆï¼ˆé€šç”¨äº¤äº’ï¼‰
            playButtonClick() {
                if (this.isMuted || !this.context || this.sfxVolume === 0) return;
                
                const freq = 200; // ä½æ²‰åšé‡
                const duration = 0.18; // æ”¾æ…¢50%
                const now = this.context.currentTime;
                
                // åšé‡æŒ‰ä¸‹é˜¶æ®µ - éŸ³é‡å¢åŠ 100% (0.63 * 2 = 1.26) * sfxVolume
                this.createMechanicalNoise(freq, duration * 0.55, 1.26 * this.sfxVolume, now);
                
                // åšé‡è§¦åº•é˜¶æ®µ - éŸ³é‡å¢åŠ 100% (0.675 * 2 = 1.35) * sfxVolume
                // ä½¿ç”¨AudioContextæ—¶é—´è°ƒåº¦ï¼Œç«‹å³æ‰§è¡Œï¼Œæ— å»¶è¿Ÿ
                this.createMechanicalNoise(freq * 0.9, duration * 0.45, 1.35 * this.sfxVolume, now + duration * 0.55);
            },
            
            // æœºæ¢°å™ªéŸ³ç”Ÿæˆå™¨ï¼ˆç”¨äºé»‘è½´éŸ³æ•ˆï¼‰
            createMechanicalNoise(centerFreq, duration, volume, startTime) {
                const bufferSize = this.context.sampleRate * duration;
                const buffer = this.context.createBuffer(1, bufferSize, this.context.sampleRate);
                const data = buffer.getChannelData(0);
                
                // ç”Ÿæˆå™ªéŸ³æ¨¡æ‹Ÿæœºæ¢°ç¢°æ’
                for (let i = 0; i < bufferSize; i++) {
                    const decay = Math.exp(-5 * i / bufferSize);
                    data[i] = (Math.random() * 2 - 1) * decay;
                }
                
                const noise = this.context.createBufferSource();
                noise.buffer = buffer;
                
                const filter = this.context.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = centerFreq;
                filter.Q.value = 3;
                
                const gain = this.context.createGain();
                gain.gain.setValueAtTime(volume, startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.context.destination);
                
                noise.start(startTime);
                noise.stop(startTime + duration);
            },
            
            // 2. å¤è€å®ç®±å±å‘€éŸ³æ•ˆï¼ˆä¿®æ”¹ç‰ˆï¼Œä»…ç¬¬ä¸€æ®µé•¿éŸ³ï¼‰
            playChestOpen() {
                if (this.isMuted || !this.context || this.sfxVolume === 0) return;
                
                const now = this.context.currentTime;
                const startFreq = 150;
                const endFreq = 180;
                const duration = 1.4;
                
                // ç”Ÿæˆå™ªéŸ³æ¨¡æ‹Ÿæœ¨è´¨æ‘©æ“¦
                const bufferSize = this.context.sampleRate * duration;
                const buffer = this.context.createBuffer(1, bufferSize, this.context.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * 0.8;
                }
                
                const noise = this.context.createBufferSource();
                noise.buffer = buffer;
                
                // å¸¦é€šæ»¤æ³¢å™¨æ¨¡æ‹Ÿæœ¨è´¨å…±æŒ¯
                const filter = this.context.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(startFreq, now);
                filter.frequency.linearRampToValueAtTime(endFreq, now + duration);
                filter.Q.value = 2;
                
                // éŸ³é‡åŒ…ç»œ - éŸ³é‡å¢åŠ 50% (0.25 * 1.5 = 0.375) * sfxVolume
                const gain = this.context.createGain();
                gain.gain.setValueAtTime(0.375 * this.sfxVolume, now);
                gain.gain.linearRampToValueAtTime(0.015 * this.sfxVolume, now + duration);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.context.destination);
                
                noise.start(now);
                noise.stop(now + duration);
            },
            
            // 3. ç«–ç´æŠ½å¡éŸ³æ•ˆï¼ˆæœ€ç»ˆç‰ˆï¼‰
            playCardDrawHarp(onComplete) {
                if (this.isMuted || !this.context) return 0;
                
                // éŸ³ç¬¦åºåˆ—ï¼šC4-D4-F4-A4-C5-B4-G4-D4-C4
                const sequence = [
                    { note: 'C4', interval: 0.2, duration: 0.5, volume: 0.04 },  // å¼±
                    { note: 'D4', interval: 0.2, duration: 0.5, volume: 0.06 },  // æ¸å¼º
                    { note: 'F4', interval: 0.2, duration: 0.5, volume: 0.08 },  // å¼º
                    { note: 'A4', interval: 0.2, duration: 0.5, volume: 0.10 },  // å¼º
                    { note: 'C5', interval: 0.2, duration: 0.5, volume: 0.12 },  // æœ€å¼º
                    { note: 'B4', interval: 0.2, duration: 0.5, volume: 0.10 },  // å¼º
                    { note: 'G4', interval: 0.2, duration: 0.5, volume: 0.08 },  // æ¸å¼±
                    { note: 'D4', interval: 0.2, duration: 0.5, volume: 0.06 },  // å¼±
                    { note: 'C4', interval: 1.0, duration: 2.0, volume: 0.04 }   // æå¼±æ”¶å°¾
                ];
                
                let currentTime = 0;
                
                sequence.forEach((item, i) => {
                    setTimeout(() => {
                        this.playHarpNote(this.noteFreqs[item.note], item.duration, item.volume);
                    }, currentTime * 1000);
                    
                    currentTime += item.interval;
                });
                
                // éŸ³ä¹ç»“æŸæ—¶é—´
                const totalDuration = sequence.slice(0, -1).reduce((sum, item) => sum + item.interval, 0) + sequence[sequence.length - 1].interval;
                
                if (onComplete) {
                    setTimeout(() => {
                        onComplete();
                    }, totalDuration * 1000);
                }
                
                return totalDuration;
            },
            
            // æ’­æ”¾å•ä¸ªç«–ç´éŸ³ç¬¦ï¼ˆå¸¦å»¶éŸ³ï¼‰
            playHarpNote(freq, duration, volume) {
                const now = this.context.currentTime;
                const osc = this.context.createOscillator();
                const gain = this.context.createGain();
                
                osc.type = 'triangle'; // ç«–ç´éŸ³è‰²
                osc.frequency.setValueAtTime(freq, now);
                
                // éŸ³é‡åŒ…ç»œï¼šå¿«é€Ÿèµ·éŸ³ï¼ŒæŒç»­ï¼Œè‡ªç„¶è¡°å‡
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(volume, now + 0.01); // å¿«é€Ÿèµ·éŸ³
                gain.gain.linearRampToValueAtTime(volume * 0.8, now + duration * 0.5); // ä¸­æ®µä¿æŒ
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration); // è‡ªç„¶è¡°å‡
                
                osc.connect(gain);
                gain.connect(this.context.destination);
                
                osc.start(now);
                osc.stop(now + duration);
            },
            
            // === ä¿ç•™çš„åŸæœ‰éŸ³æ•ˆ ===
            
            // ç”Ÿæˆå®è—éŸ³æ•ˆï¼ˆæš‚æ—¶ä¿ç•™ï¼‰
            playGenerateTreasure() {
                this.playButtonClick(); // ä½¿ç”¨é»‘è½´ç‚¹å‡»éŸ³æ•ˆ
            },
            
            // æ‰”è¿›å®ç®±éŸ³æ•ˆï¼ˆæš‚æ—¶ä¿ç•™ï¼‰
            playSaveTreasure() {
                if (this.isMuted || !this.context) return;
                
                const now = this.context.currentTime;
                
                // æ‰è½å£°
                const osc = this.context.createOscillator();
                const gain = this.context.createGain();
                
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(200, now + 0.3);
                
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                osc.connect(gain);
                gain.connect(this.context.destination);
                
                osc.start();
                osc.stop(now + 0.3);
            },
            
            // æŠ½å–å®è—éŸ³æ•ˆï¼ˆæš‚æ—¶ä¿ç•™ï¼‰
            playDrawTreasure() {
                this.playButtonClick(); // ä½¿ç”¨é»‘è½´ç‚¹å‡»éŸ³æ•ˆ
            },
            
            // åˆ é™¤éŸ³æ•ˆï¼ˆä½¿ç”¨é»‘è½´ï¼‰
            playDelete() {
                this.playButtonClick();
            }
        };

        // æ•°æ®é…ç½®
        const EMOTIONS = ['èˆ’çˆ½', 'æ˜åªš', 'çµæ„Ÿæ¶Œç°', 'å¹³é™', 'è‡ªæˆ‘å®‰æŠš', 'çƒ¦èº', 'ç„¦è™‘', 'è´Ÿé‡', 'æ„¤æ€’'];
        
        const TREASURE_MAP = {
            'èˆ’çˆ½': ['èƒœè€…çš„é‡‘å¸', 'è·ƒåŠ¨ä¹‹ç¾½', 'å¼€å°çš„åº†å…¸é…’æ¯'],
            'æ˜åªš': ['æ™¨å…‰é‡‘å¸', 'é‡‘è‰²èŠ±ç¯', 'åˆé†’çš„ç²¾çµé“ƒ'],
            'çµæ„Ÿæ¶Œç°': ['æœªå®Œæˆçš„é­”æ³•å·è½´', 'å‘å…‰ç¬¦æ–‡çŸ³', 'æ€ç»ªä¹‹ç“¶'],
            'å¹³é™': ['é™æ°´æŠ¤ç¬¦', 'å¤œè‰²ç¾½æ¯›', 'å°å­˜çš„è“å®çŸ³'],
            'è‡ªæˆ‘å®‰æŠš': ['å‘¼å¸æ²™æ¼', 'é•‡å®šç¬¦æ–‡', 'å°å°ä¸­çš„å°ç“¶'],
            'çƒ¦èº': ['è£‚å¼€çš„é‡‘å¸', 'æ‰“ç»“çš„ç¾½æ¯›', 'åµé—¹çš„ç©ºç“¶'],
            'ç„¦è™‘': ['æœªå°å£çš„ä¿¡ä»¶', 'éœ‡é¢¤çš„æ°´æ™¶', 'å€’æµçš„æ²™æ¼'],
            'è´Ÿé‡': ['æ²‰é‡é“æˆ’', 'è´Ÿé‡ä¹‹ç®±', 'å‹ä½çš„ç‹å† '],
            'æ„¤æ€’': ['ç¼çƒ­çš„çŸ­å‰‘', 'ç‡ƒçƒ§çš„ç¬¦æ–‡', 'ç ´ç¢çš„ç‹å°']
        };

        // ä¹Œé¸¦è¯­è¨€ç³»ç»Ÿ - æ ¹æ®æƒ…ç»ªæ™ºèƒ½åŒ¹é…è¯„è®º
        const RAVEN_LANGUAGE = {
            version: "1.0",
            character: {
                name: "ä¹Œé¸¦",
                role: "è§è¯è€…",
                personality: ["ä¸­ç«‹", "å…‹åˆ¶", "ç•¥å¸¦å‚²å¨‡", "ä¸è¯´æ•™", "ä¸è¯„åˆ¤"],
                tone: "ä½å£°ã€å†·é™ã€è¯—æ€§ã€ç®€çŸ­"
            },
            emotions: {
                'èˆ’çˆ½': [
                    "æˆ‘çœ‹åˆ°äº†ã€‚æ˜¯çš„ï¼Œè¿™ç¡®å®ä¸é”™ã€‚",
                    "çœ‹æ¥ä»Šå¤©çš„é£ï¼Œç«™åœ¨ä½ é‚£ä¸€è¾¹ã€‚",
                    "è¿™ç§æ„Ÿè§‰ä¸å¸¸æ¥ï¼Œä½†ä½ æŠ“ä½äº†ã€‚",
                    "å—¯â€¦â€¦è¿™ç®—å¾—ä¸Šä¸€æšå€¼å¾—æ”¶è—çš„ç¬é—´ã€‚",
                    "ä½ ç°åœ¨çš„æ­¥ä¼ï¼Œå¾ˆè½»ã€‚",
                    "æˆ‘ä¼šä¸ä½ ä¸€èµ·é“­è®°è¿™ä¸€åˆ»ã€‚",
                    "è¿™ç§å¿ƒæƒ…ï¼Œå¾ˆé€‚åˆæ…¢æ…¢èµ°ã€‚",
                    "æ²¡ä»€ä¹ˆéè¦ç«‹åˆ»å†³å®šçš„ã€‚",
                    "é£å¾ˆé¡ºï¼Œå¸Œæœ›ä¸€ç›´è¿™æ ·å¹ä¸‹å»ã€‚"
                ],
                'æ˜åªš': [
                    "ä¸å¼ æ‰¬ï¼Œå´åˆšåˆšå¥½ã€‚",
                    "ä½ ç°åœ¨çš„å¿ƒæƒ…ï¼Œåƒä¸€å—è¢«é˜³å…‰æ™’æš–çš„çŸ³å¤´ã€‚",
                    "æˆ‘çœ‹è§ä½ çš„å¿ƒåœ¨å¾®ç¬‘ï¼Œè™½ç„¶ä½ æ²¡è¯´ã€‚",
                    "è¿™ç§é«˜å…´ï¼Œä¸éœ€è¦è§£é‡Šã€‚",
                    "ç•™ç€å§ï¼Œå®ƒä¼šåœ¨æŸä¸ªæ—¶åˆ»æ´¾ä¸Šç”¨åœºã€‚",
                    "ä»Šå¤©çš„ä¸–ç•Œï¼Œçœ‹èµ·æ¥ä¸é‚£ä¹ˆæ‹¥æŒ¤ã€‚",
                    "ä½ ç«™åœ¨å…‰é‡Œï¼Œè€Œä¸æ˜¯è¢«å®ƒè¿½ç€è·‘ã€‚"
                ],
                'çµæ„Ÿæ¶Œç°': [
                    "ä½ çš„æƒ³æ³•ï¼Œæ­£åœ¨é€æ¸æ˜¾ç°ã€‚",
                    "å¥½æƒ³æ³•ã€‚",
                    "æˆ‘å¬è§å¾ˆå¤šç¿…è†€æ‹åŠ¨çš„å£°éŸ³ã€‚",
                    "æœ‰äº›å¿µå¤´ï¼Œåªé€‚åˆåœ¨è¿™ä¸ªæ—¶åˆ»å‡ºç°ã€‚",
                    "è®°ä¸‹å®ƒä»¬ï¼Œå“ªæ€•ç°åœ¨è¿˜æ²¡å½¢çŠ¶ã€‚"
                ],
                'å¹³é™': [
                    "æ²¡æœ‰ä»€ä¹ˆåœ¨æ‹‰æ‰¯ä½ ã€‚",
                    "ä½ ç°åœ¨ï¼Œå¾ˆå®Œæ•´ã€‚",
                    "è¿™ç§çŠ¶æ€ï¼Œä¸éœ€è¦è¢«æ‰“æ‰°ã€‚",
                    "å®‰é™çš„æ—¶å€™ï¼Œå¾ˆå¤šä¸œè¥¿ä¼šè‡ªå·±å½’ä½ã€‚",
                    "æˆ‘ä¼šè½»è½»åˆä¸Šè¿™ä¸€é¡µã€‚"
                ],
                'è‡ªæˆ‘å®‰æŠš': [
                    "ä½ æ­£åœ¨æŠŠè‡ªå·±ä¸€ç‚¹ç‚¹å¸¦å›æ¥ã€‚",
                    "æˆ‘çœ‹è§ä½ åœ¨æ…¢æ…¢æ”¶æ‹¢è‡ªå·±ã€‚",
                    "è¿™ä¸æ˜¯é€€è®©ï¼Œè¿™æ˜¯è°ƒæ•´ã€‚",
                    "ä½ æ²¡æœ‰æ¶ˆå¤±ï¼Œåªæ˜¯åä¸‹æ¥æ­‡äº†ä¸€ä¼šã€‚",
                    "å‘¼å¸æ¯”æƒ³æ³•æ›´å¯é ã€‚",
                    "ç»§ç»­å§ï¼Œæˆ‘å°±åœ¨æ—è¾¹ã€‚"
                ],
                'çƒ¦èº': [
                    "æˆ‘æ‡‚ï¼Œè¿™ä¸æ˜¯å¤§äº‹ï¼Œä½†å¾ˆç£¨äººã€‚",
                    "è¿™è‚¡çƒ¦æ„ï¼Œæ²¡æœ‰å½¢çŠ¶ï¼Œå´åˆ°å¤„éƒ½æ˜¯ã€‚",
                    "ä½ ç°åœ¨ä¸éœ€è¦è§£å†³å®ƒã€‚",
                    "æœ‰äº›æƒ…ç»ªï¼Œåªæ˜¯æ¥æ•²ä¸€ä¸‹é—¨ã€‚",
                    "åˆ«æ€¥ã€‚",
                    "è®°å½•ä¸‹æ¥å°±å¥½ï¼Œæˆ‘ä¼šæ›¿ä½ çœ‹ç€ã€‚"
                ],
                'ç„¦è™‘': [
                    "ä½ æ­£åœ¨ä¸ºè¿˜æ²¡å‘ç”Ÿçš„äº‹æ¶ˆè€—è‡ªå·±ã€‚",
                    "ä½ çš„å‘¼å¸ï¼Œæ¯”ä½ çš„æƒ³æ³•æ…¢ã€‚",
                    "ç°åœ¨è¿™ä¸€åˆ»ï¼Œå¹¶æ²¡æœ‰ä½ æƒ³çš„é‚£ä¹ˆå±é™©ã€‚",
                    "æˆ‘çŸ¥é“ï¼Œä½ å¾ˆæƒ³æå‰å‡†å¤‡å¥½ä¸€åˆ‡ã€‚",
                    "æ”¾åœ¨è¿™é‡Œå§ï¼Œè‡³å°‘ç°åœ¨ä¸ç”¨ä¸€ç›´æŠ±ç€å®ƒã€‚"
                ],
                'è´Ÿé‡': [
                    "ä½ æ‰›å¾—å¤ªä¹…äº†ï¼Œä½†ä½ æ²¡è¯´ã€‚",
                    "ä½ å·²ç»èµ°äº†å¾ˆè¿œã€‚",
                    "æœ‰äº›é‡é‡ï¼Œæœ¬æ¥å°±ä¸æ˜¯ä¸€ä¸ªäººæ‹¿çš„ã€‚",
                    "æˆ‘æ³¨æ„åˆ°ä½ çš„è‚©è†€ï¼Œå¾ˆä¹…æ²¡æ”¾æ¾è¿‡ã€‚",
                    "ä¸æ˜¯ä½ ä¸å¤Ÿå¥½ï¼Œæ˜¯äº‹æƒ…å¤ªå¤šã€‚",
                    "æŠŠå®ƒæ”¾è¿›ç®±å­é‡Œï¼Œå“ªæ€•åªæ˜¯ä¸€ä¼šå„¿ã€‚"
                ],
                'æ„¤æ€’': [
                    "è¿™æ˜¯æ¸…é†’çš„ä¿¡å·ï¼Œä¸æ˜¯å¤±æ§ã€‚",
                    "è¿™ä¸æ˜¯æ— ç¼˜æ— æ•…çš„ã€‚",
                    "æœ‰ä¸œè¥¿è¶Šç•Œäº†ã€‚",
                    "ä½ çš„æ„¤æ€’ï¼Œå¾ˆæ˜ç¡®ã€‚",
                    "ä¸å¿…ç«‹åˆ»è¡ŒåŠ¨ï¼Œä½†ä¹Ÿåˆ«å‡è£…æ²¡å‘ç”Ÿã€‚",
                    "ä¸è¦å¿˜è®°ï¼Œä¹Ÿä¸è¦å¤±æ§ã€‚"
                ]
            },
            // é€šç”¨è¯„è®ºï¼ˆå½“æ— æ³•åŒ¹é…æƒ…ç»ªæ—¶ä½¿ç”¨ï¼‰
            general: [
                "æ”¶ä¸‹äº†ã€‚",
                "ä¹Œé¸¦è®°ä½äº†ã€‚",
                "ä¸æ˜¯éšä¾¿ä»€ä¹ˆéƒ½ä¼šè¢«ç•™ä¸‹ã€‚",
                "è¿™ä¸€ä»¶ï¼Œä½ å½“æ—¶æ”¾å¾—å¾ˆæ€¥ã€‚",
                "ä½ ä»¥å‰ç•™ä¸‹çš„ã€‚",
                "è¿™é‡Œè¿˜å¾ˆå®‰é™ã€‚"
            ]
        };

        // è·å–ä¹Œé¸¦è¯„è®ºçš„å‡½æ•°
        function getRavenComment(emotion) {
            // å¦‚æœæœ‰å¯¹åº”æƒ…ç»ªçš„è¯„è®ºï¼Œä»ä¸­éšæœºé€‰æ‹©
            if (RAVEN_LANGUAGE.emotions[emotion] && RAVEN_LANGUAGE.emotions[emotion].length > 0) {
                const comments = RAVEN_LANGUAGE.emotions[emotion];
                return comments[Math.floor(Math.random() * comments.length)];
            }
            // å¦åˆ™ä½¿ç”¨é€šç”¨è¯„è®º
            return RAVEN_LANGUAGE.general[Math.floor(Math.random() * RAVEN_LANGUAGE.general.length)];
        }

        // ç”Ÿæˆå®è—SVGå›¾æ¡ˆ
        function getTreasureSVG(treasureName) {
            const color = '#C9A961';
            const darkColor = '#8B6F47';
            
            // é‡‘å¸ç±»
            if (treasureName.includes('é‡‘å¸')) {
                const isCracked = treasureName.includes('è£‚å¼€');
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="35" fill="${color}" stroke="${darkColor}" stroke-width="3"/>
                        <circle cx="50" cy="50" r="28" fill="none" stroke="${darkColor}" stroke-width="2"/>
                        <text x="50" y="60" text-anchor="middle" font-size="32" font-weight="bold" fill="${darkColor}">Â¥</text>
                        ${isCracked ? '<path d="M 30 30 L 70 70 M 70 30 L 30 70" stroke="#A64B3A" stroke-width="3"/>' : ''}
                    </svg>
                `;
            }
            
            // ç¾½æ¯›ç±»
            if (treasureName.includes('ç¾½')) {
                const isTangled = treasureName.includes('æ‰“ç»“');
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <path d="M 50 15 Q 48 35, 46 55 Q 44 75, 42 90" 
                              fill="none" stroke="${color}" stroke-width="4" stroke-linecap="round"/>
                        ${!isTangled ? `
                            <path d="M 46 30 Q 30 32, 25 35" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 45 40 Q 28 42, 22 45" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 44 50 Q 26 52, 20 55" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 43 60 Q 24 62, 18 65" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 42 70 Q 22 72, 16 75" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 54 30 Q 70 32, 75 35" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 55 40 Q 72 42, 78 45" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 56 50 Q 74 52, 80 55" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 57 60 Q 76 62, 82 65" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 58 70 Q 78 72, 84 75" fill="none" stroke="${color}" stroke-width="2"/>
                        ` : `
                            <path d="M 46 45 Q 65 40, 55 60 Q 45 50, 50 70" fill="none" stroke="${color}" stroke-width="3"/>
                            <path d="M 54 45 Q 35 40, 45 60 Q 55 50, 50 70" fill="none" stroke="${color}" stroke-width="3"/>
                        `}
                    </svg>
                `;
            }
            
            // é…’æ¯ç±»
            if (treasureName.includes('é…’æ¯')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <path d="M 30 20 L 35 60 Q 35 75, 50 75 Q 65 75, 65 60 L 70 20 Z" 
                              fill="${color}" stroke="${color}" stroke-width="3"/>
                        <rect x="25" y="15" width="50" height="8" fill="${color}" rx="2"/>
                        <rect x="45" y="75" width="10" height="15" fill="${color}"/>
                    </svg>
                `;
            }
            
            // ç©ºç“¶ç±»
            if (treasureName.includes('ç©ºç“¶')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <g transform="rotate(-10 50 50)">
                            <path d="M 42 25 L 42 35 Q 40 40, 40 45 L 40 70 Q 40 75, 45 75 L 55 75 Q 60 75, 60 70 L 60 45 Q 60 40, 58 35 L 58 25 Z" 
                                  fill="none" stroke="${color}" stroke-width="3"/>
                            <rect x="44" y="18" width="12" height="7" fill="none" stroke="${color}" stroke-width="3"/>
                            <ellipse cx="50" cy="18" rx="6" ry="2" fill="none" stroke="${color}" stroke-width="2"/>
                            <path d="M 46 20 L 48 22 L 46 24 L 48 26" fill="none" stroke="#4A90E2" stroke-width="1.5"/>
                            <path d="M 54 20 L 52 22 L 54 24 L 52 26" fill="none" stroke="#4A90E2" stroke-width="1.5"/>
                            <path d="M 43 40 L 45 43 L 43 46 L 45 49 L 43 52" fill="none" stroke="#4A90E2" stroke-width="1.5" opacity="0.8"/>
                            <path d="M 50 42 L 52 45 L 50 48 L 52 51 L 50 54" fill="none" stroke="#4A90E2" stroke-width="1.5" opacity="0.8"/>
                            <path d="M 57 40 L 55 43 L 57 46 L 55 49 L 57 52" fill="none" stroke="#4A90E2" stroke-width="1.5" opacity="0.8"/>
                            <path d="M 46 58 L 48 61 L 46 64" fill="none" stroke="#4A90E2" stroke-width="1.5" opacity="0.6"/>
                            <path d="M 54 58 L 52 61 L 54 64" fill="none" stroke="#4A90E2" stroke-width="1.5" opacity="0.6"/>
                        </g>
                    </svg>
                `;
            }
            
            // èŠ±ç¯ç±»
            if (treasureName.includes('èŠ±ç¯')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="30" fill="none" stroke="${color}" stroke-width="4"/>
                        <circle cx="50" cy="20" r="8" fill="${color}"/>
                        <circle cx="80" cy="50" r="8" fill="${color}"/>
                        <circle cx="50" cy="80" r="8" fill="${color}"/>
                        <circle cx="20" cy="50" r="8" fill="${color}"/>
                        <circle cx="65" cy="30" r="6" fill="${darkColor}"/>
                        <circle cx="70" cy="70" r="6" fill="${darkColor}"/>
                        <circle cx="30" cy="70" r="6" fill="${darkColor}"/>
                        <circle cx="35" cy="30" r="6" fill="${darkColor}"/>
                    </svg>
                `;
            }
            
            // é“ƒé“›ç±»
            if (treasureName.includes('é“ƒ')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <path d="M 50 20 L 35 60 Q 35 70, 50 70 Q 65 70, 65 60 L 50 20 Z" 
                              fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        <circle cx="50" cy="72" r="6" fill="${darkColor}"/>
                        <line x1="50" y1="10" x2="50" y2="20" stroke="${darkColor}" stroke-width="3"/>
                        <circle cx="50" cy="10" r="4" fill="${color}"/>
                    </svg>
                `;
            }
            
            // å·è½´ç±»
            if (treasureName.includes('å·è½´')) {
                const isUnfinished = treasureName.includes('æœªå®Œæˆ');
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <path d="M 25 30 Q 20 50, 25 70 L 75 70 Q 80 50, 75 30 Z" 
                              fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        <ellipse cx="25" cy="50" rx="5" ry="22" fill="${darkColor}"/>
                        <ellipse cx="23" cy="50" rx="3" ry="20" fill="${color}"/>
                        <ellipse cx="75" cy="50" rx="5" ry="22" fill="${darkColor}"/>
                        <ellipse cx="77" cy="50" rx="3" ry="20" fill="${color}"/>
                        <line x1="35" y1="40" x2="65" y2="40" stroke="${darkColor}" stroke-width="2"/>
                        <line x1="35" y1="50" x2="65" y2="50" stroke="${darkColor}" stroke-width="2"/>
                        <line x1="35" y1="60" x2="${isUnfinished ? 50 : 65}" y2="60" stroke="${darkColor}" stroke-width="2"/>
                        ${isUnfinished ? '<text x="60" y="65" font-size="18" font-weight="bold" fill="#A64B3A">?</text>' : ''}
                    </svg>
                `;
            }
            
            // ä¿¡ä»¶ç±»
            if (treasureName.includes('ä¿¡ä»¶')) {
                const isUnsealed = treasureName.includes('æœªå°å£');
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        ${isUnsealed ? `
                            <rect x="28" y="20" width="44" height="60" fill="#D4C5A9" stroke="${darkColor}" stroke-width="2" rx="3"/>
                            <line x1="35" y1="20" x2="35" y2="80" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="43" y1="20" x2="43" y2="80" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="50" y1="20" x2="50" y2="80" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="57" y1="20" x2="57" y2="80" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="65" y1="20" x2="65" y2="80" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="38" y1="28" x2="38" y2="60" stroke="${darkColor}" stroke-width="1.5"/>
                            <line x1="46" y1="28" x2="46" y2="60" stroke="${darkColor}" stroke-width="1.5"/>
                            <line x1="54" y1="28" x2="54" y2="60" stroke="${darkColor}" stroke-width="1.5"/>
                            <line x1="62" y1="28" x2="62" y2="45" stroke="${darkColor}" stroke-width="1.5"/>
                            <text x="62" y="58" font-size="16" font-weight="bold" fill="#A64B3A">â€¦</text>
                            <path d="M 50 15 Q 45 17, 48 20" fill="none" stroke="#8B4513" stroke-width="2"/>
                            <path d="M 50 15 Q 55 17, 52 20" fill="none" stroke="#8B4513" stroke-width="2"/>
                            <circle cx="50" cy="15" r="2" fill="#8B4513"/>
                        ` : `
                            <rect x="28" y="25" width="44" height="50" fill="#D4C5A9" stroke="${darkColor}" stroke-width="2" rx="3"/>
                            <line x1="35" y1="25" x2="35" y2="75" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="43" y1="25" x2="43" y2="75" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="50" y1="25" x2="50" y2="75" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="57" y1="25" x2="57" y2="75" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="65" y1="25" x2="65" y2="75" stroke="${darkColor}" stroke-width="1" opacity="0.2"/>
                            <line x1="38" y1="33" x2="38" y2="67" stroke="${darkColor}" stroke-width="1.5"/>
                            <line x1="46" y1="33" x2="46" y2="67" stroke="${darkColor}" stroke-width="1.5"/>
                            <line x1="54" y1="33" x2="54" y2="67" stroke="${darkColor}" stroke-width="1.5"/>
                            <line x1="62" y1="33" x2="62" y2="67" stroke="${darkColor}" stroke-width="1.5"/>
                            <path d="M 35 22 Q 50 18, 65 22" fill="none" stroke="#8B4513" stroke-width="2.5"/>
                            <path d="M 48 18 L 48 28" fill="none" stroke="#8B4513" stroke-width="2"/>
                            <path d="M 52 18 L 52 28" fill="none" stroke="#8B4513" stroke-width="2"/>
                            <circle cx="50" cy="50" r="10" fill="#A64B3A"/>
                            <circle cx="50" cy="50" r="7" fill="none" stroke="${color}" stroke-width="1.5"/>
                            <text x="50" y="55" text-anchor="middle" font-size="11" font-weight="bold" fill="${color}">å°</text>
                        `}
                    </svg>
                `;
            }
            
            // ç¬¦æ–‡çŸ³ç±»
            if (treasureName.includes('ç¬¦æ–‡')) {
                const isBurning = treasureName.includes('ç‡ƒçƒ§');
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <polygon points="50,15 70,40 65,70 35,70 30,40" fill="${color}" stroke="${darkColor}" stroke-width="3"/>
                        <text x="50" y="55" text-anchor="middle" font-size="28" font-weight="bold" fill="${darkColor}">áš±</text>
                        ${isBurning ? `
                            <path d="M 45 10 Q 40 5, 42 0" fill="none" stroke="#E74C3C" stroke-width="2"/>
                            <path d="M 50 8 Q 48 3, 50 -2" fill="none" stroke="#E74C3C" stroke-width="2"/>
                            <path d="M 55 10 Q 58 5, 56 0" fill="none" stroke="#E74C3C" stroke-width="2"/>
                        ` : ''}
                    </svg>
                `;
            }
            
            // ç“¶å­ç±»ï¼ˆæ€ç»ªä¹‹ç“¶ã€å°å°ä¸­çš„å°ç“¶ï¼‰
            if (treasureName.includes('ç“¶') && !treasureName.includes('ç©ºç“¶')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <rect x="35" y="30" width="30" height="5" fill="${darkColor}"/>
                        <rect x="38" y="22" width="24" height="8" fill="${color}"/>
                        <path d="M 38 35 Q 35 40, 35 50 L 35 75 Q 35 80, 40 80 L 60 80 Q 65 80, 65 75 L 65 50 Q 65 40, 62 35 Z" 
                              fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        <ellipse cx="50" cy="55" rx="8" ry="12" fill="${darkColor}" opacity="0.3"/>
                    </svg>
                `;
            }
            
            // æŠ¤ç¬¦ç±»
            if (treasureName.includes('æŠ¤ç¬¦')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <circle cx="50" cy="55" r="25" fill="${color}" stroke="${darkColor}" stroke-width="3"/>
                        <path d="M 50 30 L 55 45 L 70 45 L 58 54 L 62 68 L 50 60 L 38 68 L 42 54 L 30 45 L 45 45 Z" 
                              fill="${darkColor}"/>
                        <path d="M 45 20 Q 45 15, 50 15 Q 55 15, 55 20" fill="none" stroke="${color}" stroke-width="3"/>
                        <circle cx="50" cy="15" r="4" fill="${color}"/>
                    </svg>
                `;
            }
            
            // è“å®çŸ³ç±»
            if (treasureName.includes('å®çŸ³')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <polygon points="50,20 70,40 60,75 40,75 30,40" fill="#4A90E2" stroke="#2E5C8A" stroke-width="3"/>
                        <polygon points="50,20 70,40 50,50" fill="#5BA3F5" opacity="0.7"/>
                        <polygon points="50,20 30,40 50,50" fill="#357ABD" opacity="0.7"/>
                        <path d="M 30 40 L 50 50 L 40 75" fill="#2E5C8A" opacity="0.5"/>
                        <path d="M 70 40 L 50 50 L 60 75" fill="#5BA3F5" opacity="0.5"/>
                    </svg>
                `;
            }
            
            // æ²™æ¼ç±»
            if (treasureName.includes('æ²™æ¼')) {
                const isReversed = treasureName.includes('å€’æµ');
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <rect x="30" y="15" width="40" height="8" fill="${darkColor}" rx="2"/>
                        <rect x="30" y="77" width="40" height="8" fill="${darkColor}" rx="2"/>
                        <path d="M 35 23 L 50 50 L 35 77 M 65 23 L 50 50 L 65 77" 
                              fill="none" stroke="${color}" stroke-width="3"/>
                        ${isReversed ? 
                            `<path d="M 35 25 L 50 45 L 65 25 Z" fill="${color}"/>` :
                            `<path d="M 35 75 L 50 55 L 65 75 Z" fill="${color}"/>`
                        }
                        <circle cx="50" cy="50" r="3" fill="${darkColor}"/>
                    </svg>
                `;
            }
            
            // æ°´æ™¶ç±»
            if (treasureName.includes('æ°´æ™¶')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <polygon points="50,20 65,40 60,70 40,70 35,40" fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        <line x1="50" y1="20" x2="50" y2="70" stroke="${darkColor}" stroke-width="2"/>
                        <line x1="35" y1="40" x2="65" y2="40" stroke="${darkColor}" stroke-width="2"/>
                        <line x1="40" y1="70" x2="65" y2="40" stroke="${darkColor}" stroke-width="1" opacity="0.5"/>
                        <line x1="60" y1="70" x2="35" y2="40" stroke="${darkColor}" stroke-width="1" opacity="0.5"/>
                        <circle cx="45" cy="35" r="3" fill="white" opacity="0.6"/>
                    </svg>
                `;
            }
            
            // é“æˆ’ç±»
            if (treasureName.includes('é“æˆ’')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="28" fill="none" stroke="${darkColor}" stroke-width="8"/>
                        <circle cx="50" cy="50" r="20" fill="none" stroke="${color}" stroke-width="3"/>
                        <rect x="45" y="15" width="10" height="15" fill="${darkColor}" rx="2"/>
                        <circle cx="50" cy="22" r="6" fill="${color}"/>
                    </svg>
                `;
            }
            
            // ç®±å­ç±»
            if (treasureName.includes('ç®±')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <rect x="25" y="40" width="50" height="35" fill="${color}" stroke="${darkColor}" stroke-width="3"/>
                        <path d="M 25 40 L 35 30 L 85 30 L 75 40 Z" fill="${darkColor}"/>
                        <rect x="25" y="40" width="50" height="8" fill="${darkColor}"/>
                        <rect x="47" y="52" width="6" height="15" fill="${darkColor}" rx="1"/>
                        <circle cx="50" cy="62" r="3" fill="${color}"/>
                        <line x1="30" y1="48" x2="70" y2="48" stroke="${color}" stroke-width="2"/>
                    </svg>
                `;
            }
            
            // ç‹å† ç±»
            if (treasureName.includes('ç‹å† ') || treasureName.includes('ç‹å°')) {
                const isBroken = treasureName.includes('ç ´ç¢') || treasureName.includes('å‹ä½');
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        ${isBroken ? 
                            '<path d="M 25 55 L 30 40 L 50 50 L 70 40 L 75 55 L 65 60 M 55 58 L 45 62 M 40 60 L 30 58" fill="' + color + '" stroke="' + darkColor + '" stroke-width="3"/>' :
                            '<path d="M 25 55 L 30 40 L 50 50 L 70 40 L 75 55 L 65 65 L 35 65 Z" fill="' + color + '" stroke="' + darkColor + '" stroke-width="3"/>'
                        }
                        <circle cx="30" cy="40" r="5" fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        <circle cx="50" cy="50" r="5" fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        <circle cx="70" cy="40" r="5" fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        ${isBroken ? '<path d="M 40 45 L 60 65" stroke="#A64B3A" stroke-width="3"/>' : ''}
                    </svg>
                `;
            }
            
            // çŸ­å‰‘ç±»
            if (treasureName.includes('çŸ­å‰‘')) {
                return `
                    <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                        <rect x="46" y="20" width="8" height="50" fill="${color}" stroke="${darkColor}" stroke-width="2"/>
                        <polygon points="50,15 45,20 55,20" fill="${darkColor}"/>
                        <rect x="40" y="68" width="20" height="8" fill="${darkColor}"/>
                        <rect x="45" y="76" width="10" height="6" fill="${color}"/>
                        <path d="M 35 40 Q 30 35, 35 30" fill="none" stroke="#E74C3C" stroke-width="2"/>
                        <path d="M 40 45 Q 35 40, 40 35" fill="none" stroke="#E74C3C" stroke-width="2"/>
                        <path d="M 65 40 Q 70 35, 65 30" fill="none" stroke="#E74C3C" stroke-width="2"/>
                    </svg>
                `;
            }
            
            // é»˜è®¤å®çŸ³å›¾æ¡ˆ
            return `
                <svg class="treasure-svg-icon" viewBox="0 0 100 100">
                    <polygon points="50,20 70,40 60,75 40,75 30,40" fill="${color}" stroke="${darkColor}" stroke-width="3"/>
                    <polygon points="50,20 70,40 50,50" fill="${darkColor}" opacity="0.3"/>
                    <polygon points="50,20 30,40 50,50" fill="${darkColor}" opacity="0.5"/>
                </svg>
            `;
        }

        // è·å–é­”æ³•é˜µç±»å
        function getCircleClassName(type) {
            const names = {
                1: 'circle-classic',
                2: 'circle-rune',
                3: 'circle-spiral',
                6: 'circle-ancient'
            };
            return names[type];
        }

        // è·å–é­”æ³•é˜µHTML
        function getCircleHTML(type) {
            switch(type) {
                case 1: // ç»å…¸å…­èŠ’æ˜Ÿ
                    return `
                        <div class="outer-ring"></div>
                        <div class="inner-ring"></div>
                        <div class="dots-container">
                            <div class="dot" style="top: -4px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="dot" style="bottom: -4px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="dot" style="top: 50%; left: -4px; transform: translateY(-50%);"></div>
                            <div class="dot" style="top: 50%; right: -4px; transform: translateY(-50%);"></div>
                            <div class="dot" style="top: 15%; right: 15%;"></div>
                            <div class="dot" style="bottom: 15%; left: 15%;"></div>
                        </div>
                    `;
                case 2: // ç¬¦æ–‡ä¸‰ç¯
                    return `
                        <div class="ring ring-1"></div>
                        <div class="ring ring-2"></div>
                        <div class="ring ring-3"></div>
                        <div class="rune-container">
                            <div class="rune-symbol" style="top: -10px; left: 50%; transform: translateX(-50%);">áš›</div>
                            <div class="rune-symbol" style="bottom: -10px; left: 50%; transform: translateX(-50%);">ášœ</div>
                            <div class="rune-symbol" style="top: 50%; left: -10px; transform: translateY(-50%);">áš‘</div>
                            <div class="rune-symbol" style="top: 50%; right: -10px; transform: translateY(-50%);">áš</div>
                        </div>
                    `;
                case 3: // é˜´é˜³èºæ—‹
                    return `
                        <div class="spiral-ring"></div>
                        <div class="spiral-ring spiral-ring-2"></div>
                    `;
                case 6: // å¤æ–‡å°å°
                    return `
                        <div class="ancient-ring"></div>
                        <div class="inner-ancient"></div>
                        <div class="ancient-container">
                            <div class="ancient-symbol" style="top: -15px; left: 50%; transform: translateX(-50%);">å</div>
                            <div class="ancient-symbol" style="bottom: -15px; left: 50%; transform: translateX(-50%);">å</div>
                            <div class="ancient-symbol" style="top: 50%; left: -15px; transform: translateY(-50%);">â˜°</div>
                            <div class="ancient-symbol" style="top: 50%; right: -15px; transform: translateY(-50%);">â˜·</div>
                        </div>
                    `;
            }
        }

        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticles(containerId) {
            const container = document.getElementById(`${containerId}-particles`);
            if (!container) return;
            
            container.innerHTML = ''; // æ¸…ç©ºå·²æœ‰ç²’å­
            
            const particleCount = 12;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const angle = (i / particleCount) * Math.PI * 2;
                const distance = 60 + Math.random() * 20;
                
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                const delay = Math.random() * 2;
                const duration = 2 + Math.random() * 1;
                
                particle.style.animation = `particle-burst ${duration}s ease-out ${delay}s infinite`;
                
                container.appendChild(particle);
            }
        }

        // åˆ›å»ºç«èŠ±å››å°„æ•ˆæœ
        function createSparks(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const sparkCount = 20;
            for (let i = 0; i < sparkCount; i++) {
                const spark = document.createElement('div');
                spark.className = 'spark';
                
                const angle = Math.random() * Math.PI * 2;
                const distance = 40 + Math.random() * 60;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                spark.style.left = x + 'px';
                spark.style.top = y + 'px';
                spark.style.setProperty('--tx', tx + 'px');
                spark.style.setProperty('--ty', ty + 'px');
                spark.style.setProperty('--rotation', Math.random() * 360 + 'deg');
                spark.style.animation = `spark-fly ${0.4 + Math.random() * 0.2}s ease-out`;
                
                button.appendChild(spark);
                
                setTimeout(() => spark.remove(), 600);
            }
        }

        // å…¨å±€çŠ¶æ€
        let selectedEmotion = '';
        let treasures = [];
        let currentTreasure = null;

        // åˆå§‹åŒ–
        function init() {
            loadTreasures();
            renderEmotions();
            updateTreasureBox();
            updateProfileCount();
            
            document.getElementById('contentInput').addEventListener('input', updateGenerateButton);
            
            // AIæœåŠ¡çŠ¶æ€æ›´æ–°å·²ç§»é™¤ - å¼€å‘è€…æ¨¡å¼
            
            // è‡ªåŠ¨åˆå§‹åŒ–
            AudioSystem.init();
            // ä½¿ç”¨çŸ­å»¶è¿Ÿç¡®ä¿é¡µé¢åŠ è½½å®Œæˆ
            setTimeout(() => {
                AudioSystem.playBGMusic();
            }, 100);
        }

        // æ¸²æŸ“æƒ…ç»ªé€‰æ‹©
        function renderEmotions() {
            const list = document.getElementById('emotionList');
            list.innerHTML = EMOTIONS.map(emotion => 
                `<button class="emotion-btn" onclick="selectEmotion('${emotion}')">
                    <span class="emotion-icon ${emotion}"></span>
                    ${emotion}
                </button>`
            ).join('');
            
            // é¼ æ ‡æ‹–æ‹½æ»šåŠ¨
            let isDown = false;
            let startX;
            let scrollLeft;
            
            list.addEventListener('mousedown', (e) => {
                isDown = true;
                list.style.cursor = 'grabbing';
                startX = e.pageX - list.offsetLeft;
                scrollLeft = list.scrollLeft;
            });
            
            list.addEventListener('mouseleave', () => {
                isDown = false;
                list.style.cursor = 'grab';
            });
            
            list.addEventListener('mouseup', () => {
                isDown = false;
                list.style.cursor = 'grab';
            });
            
            list.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - list.offsetLeft;
                const walk = (x - startX) * 2;
                list.scrollLeft = scrollLeft - walk;
            });
            
            list.style.cursor = 'grab';
        }

        // é€‰æ‹©æƒ…ç»ª
        function selectEmotion(emotion) {
            AudioSystem.playButtonClick(); // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
            selectedEmotion = emotion;
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.trim() === emotion);
            });
            updateGenerateButton();
        }

        // æ›´æ–°ç”ŸæˆæŒ‰é’®
        function updateGenerateButton() {
            const content = document.getElementById('contentInput').value.trim();
            const btn = document.getElementById('generateBtn');
            btn.disabled = !selectedEmotion || !content;
        }

        // ç”Ÿæˆå®è—
        async function generateTreasure() {
            AudioSystem.playGenerateTreasure(); // æ’­æ”¾ç”ŸæˆéŸ³æ•ˆ
            
            const btn = document.getElementById('generateBtn');
            const content = document.getElementById('contentInput').value.trim();
            
            if (!selectedEmotion || !content) return;

            btn.classList.add('loading');
            btn.disabled = true;
            
            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„åŠ è½½æ–‡å­—
            const mode = aiService.getCurrentMode();
            const loadingText = mode === 'ai' ? 'AIåˆ›ä½œä¸­...' : 'ç”Ÿæˆä¸­...';
            btn.textContent = loadingText;

            try {
                // ä½¿ç”¨AIæœåŠ¡ç”Ÿæˆå®è—
                const aiResult = await aiService.generateTreasure(selectedEmotion, content);
                
                const treasure = {
                    id: Date.now(),
                    name: aiResult.treasure_name,
                    content: content,
                    emotion: selectedEmotion,
                    comment: aiResult.crow_comment,
                    timestamp: Date.now(), // åŸå§‹æ—¶é—´æˆ³ï¼Œç”¨äºè®¡ç®—è®°å½•å¤©æ•°
                    time: new Date().toLocaleString('zh-CN', { 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }),
                    source: aiResult.source // 'ai' æˆ– 'local'
                };

                btn.classList.remove('loading');
                btn.textContent = 'ç”Ÿæˆå®è—';
                btn.disabled = true;

                // æ˜¾ç¤ºæ¥æºæç¤ºï¼ˆä»…åœ¨æ§åˆ¶å°ï¼‰
                if (aiResult.source === 'ai') {
                    console.log('âœ¨ AIç”Ÿæˆçš„å®è—:', treasure.name);
                } else {
                    console.log('ğŸ“š æœ¬åœ°åº“ç”Ÿæˆçš„å®è—:', treasure.name);
                }

                showTreasurePreview(treasure);
                
            } catch (error) {
                console.error('ç”Ÿæˆå®è—å¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                btn.classList.remove('loading');
                btn.textContent = 'ç”Ÿæˆå®è—';
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºå®è—é¢„è§ˆ
        function showTreasurePreview(treasure) {
            // éšæœºé€‰æ‹©é­”æ³•é˜µç±»å‹ï¼ˆ1,2,3,6ï¼‰
            const circleTypes = [1, 2, 3, 6];
            const circleType = circleTypes[Math.floor(Math.random() * circleTypes.length)];
            
            const modal = document.getElementById('treasurePreviewModal');
            modal.innerHTML = `
                <div class="preview-treasure-icon">
                    <div class="magic-circle-container ${getCircleClassName(circleType)}">
                        ${getCircleHTML(circleType)}
                        <div class="particles-container" id="preview-particles"></div>
                        ${getTreasureSVG(treasure.name)}
                    </div>
                </div>
                <div class="preview-treasure-name">${treasure.name}</div>
                <div class="preview-treasure-content">${treasure.content}</div>
                <div class="preview-treasure-meta">
                    <span class="preview-emotion-tag">
                        <span class="emotion-icon ${treasure.emotion}"></span>
                        ${treasure.emotion}
                    </span>
                    <span class="preview-treasure-time">${treasure.time}</span>
                </div>
                <div class="preview-crow-comment">"${treasure.comment}"</div>
                <div class="preview-actions">
                    <button class="preview-btn save" onclick="saveTreasureToBox()">æ‰”è¿›å®ç®±</button>
                </div>
                <div class="treasure-card-actions">
                    <button class="icon-btn share-icon" onclick="openSharePanel()" title="åˆ†äº«">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.5" y1="13.5" x2="15.5" y2="17.5"/>
                            <line x1="8.5" y1="10.5" x2="15.5" y2="6.5"/>
                        </svg>
                    </button>
                    <button class="icon-btn download-icon" onclick="downloadTreasureCard()" title="ä¿å­˜å›¾ç‰‡">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                    <button class="icon-btn cancel-icon" onclick="cancelTreasure()" title="å–æ¶ˆæŠ•é€’">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                    </button>
                </div>
            `;
            
            window.pendingTreasure = treasure;
            
            // åˆ›å»ºç²’å­æ•ˆæœ
            setTimeout(() => createParticles('preview'), 0);
            
            // ä¸ºæ‰”è¿›å®ç®±æŒ‰é’®æ·»åŠ ç«èŠ±æ•ˆæœ
            setTimeout(() => {
                const saveBtn = modal.querySelector('.preview-btn.save');
                if (saveBtn) {
                    saveBtn.addEventListener('click', createSparks);
                }
            }, 0);
            
            const overlay = document.getElementById('overlay');
            overlay.classList.add('active');
            modal.classList.add('active');
        }

        // ä¿å­˜å®è—
        function saveTreasureToBox() {
            if (!window.pendingTreasure) return;
            
            AudioSystem.playChestOpen(); // æ’­æ”¾å®ç®±æ‰“å¼€éŸ³æ•ˆï¼ˆæ‰”è¿›å®ç®±ï¼‰
            
            treasures.unshift(window.pendingTreasure);
            saveTreasures();
            
            closeTreasurePreview();
            showToast('å®è—å·²ä¿å­˜');
            
            document.getElementById('contentInput').value = '';
            selectedEmotion = '';
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('active'));
            
            updateTreasureBox();
            updateProfileCount();
            
            window.pendingTreasure = null;
        }

        // å–æ¶ˆæŠ•é€’
        function cancelTreasure() {
            closeTreasurePreview();
            
            document.getElementById('contentInput').value = '';
            selectedEmotion = '';
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('active'));
            
            window.pendingTreasure = null;
            showToast('å·²å–æ¶ˆ');
        }

        // å…³é—­é¢„è§ˆ
        function closeTreasurePreview() {
            const overlay = document.getElementById('overlay');
            const modal = document.getElementById('treasurePreviewModal');
            overlay.classList.remove('active');
            modal.classList.remove('active');
        }

        // æ›´æ–°å®ç®±
        function updateTreasureBox() {
            const content = document.getElementById('treasureBoxContent');
            
            const illustration = `
                <div class="treasure-illustration">
                    <!-- ä¸Šå‡å…‰ç‚¹ç²’å­ -->
                    <div class="particles-rising" id="treasureParticles"></div>
                    
                    <!-- å®ç®±SVG -->
                    <svg viewBox="0 0 240 240">
                        <!-- å®ç®±ä¸»ä½“ï¼ˆä¸åŠ¨ï¼‰ -->
                        <g id="chest-body">
                            <!-- ç®±ä½“ -->
                            <rect x="48" y="120" width="144" height="80" rx="3" 
                                  fill="none" stroke="#5D4E37" stroke-width="3"/>
                            
                            <!-- æœ¨æ¿æ¡çº¹ï¼ˆå‚ç›´çº¿æ¡ï¼‰ -->
                            <line x1="66" y1="120" x2="66" y2="200" stroke="#8b7355" stroke-width="2"/>
                            <line x1="84" y1="120" x2="84" y2="200" stroke="#8b7355" stroke-width="2"/>
                            <line x1="102" y1="120" x2="102" y2="200" stroke="#8b7355" stroke-width="2"/>
                            <line x1="120" y1="120" x2="120" y2="200" stroke="#8b7355" stroke-width="2"/>
                            <line x1="138" y1="120" x2="138" y2="200" stroke="#8b7355" stroke-width="2"/>
                            <line x1="156" y1="120" x2="156" y2="200" stroke="#8b7355" stroke-width="2"/>
                            <line x1="174" y1="120" x2="174" y2="200" stroke="#8b7355" stroke-width="2"/>
                            
                            <!-- é‡‘å±ç®ï¼ˆä¸Šï¼‰ -->
                            <rect x="43" y="128" width="156" height="10" rx="2" 
                                  fill="none" stroke="#C9A961" stroke-width="3"/>
                            <!-- é“†é’‰ -->
                            <circle cx="53" cy="133" r="3" fill="#C9A961"/>
                            <circle cx="75" cy="133" r="3" fill="#C9A961"/>
                            <circle cx="97" cy="133" r="3" fill="#C9A961"/>
                            <circle cx="120" cy="133" r="3" fill="#C9A961"/>
                            <circle cx="143" cy="133" r="3" fill="#C9A961"/>
                            <circle cx="165" cy="133" r="3" fill="#C9A961"/>
                            <circle cx="187" cy="133" r="3" fill="#C9A961"/>
                            
                            <!-- é‡‘å±ç®ï¼ˆä¸­ï¼‰ -->
                            <rect x="43" y="155" width="156" height="10" rx="2" 
                                  fill="none" stroke="#C9A961" stroke-width="3"/>
                            <!-- é“†é’‰ -->
                            <circle cx="53" cy="160" r="3" fill="#C9A961"/>
                            <circle cx="75" cy="160" r="3" fill="#C9A961"/>
                            <circle cx="97" cy="160" r="3" fill="#C9A961"/>
                            <circle cx="120" cy="160" r="3" fill="#C9A961"/>
                            <circle cx="143" cy="160" r="3" fill="#C9A961"/>
                            <circle cx="165" cy="160" r="3" fill="#C9A961"/>
                            <circle cx="187" cy="160" r="3" fill="#C9A961"/>
                            
                            <!-- é‡‘å±ç®ï¼ˆä¸‹ï¼‰ -->
                            <rect x="43" y="182" width="156" height="10" rx="2" 
                                  fill="none" stroke="#C9A961" stroke-width="3"/>
                            <!-- é“†é’‰ -->
                            <circle cx="53" cy="187" r="3" fill="#C9A961"/>
                            <circle cx="75" cy="187" r="3" fill="#C9A961"/>
                            <circle cx="97" cy="187" r="3" fill="#C9A961"/>
                            <circle cx="120" cy="187" r="3" fill="#C9A961"/>
                            <circle cx="143" cy="187" r="3" fill="#C9A961"/>
                            <circle cx="165" cy="187" r="3" fill="#C9A961"/>
                            <circle cx="187" cy="187" r="3" fill="#C9A961"/>
                            
                            <!-- é”æ‰£ -->
                            <ellipse cx="120" cy="150" rx="12" ry="15" 
                                     fill="none" stroke="#C9A961" stroke-width="3"/>
                            <rect x="118" y="150" width="4" height="18" rx="1" 
                                  fill="none" stroke="#C9A961" stroke-width="2"/>
                            <circle cx="120" cy="155" r="4" fill="#C9A961"/>
                        </g>

                        <!-- ç›–å­ï¼ˆåŠ¨ç”»ï¼‰ -->
                        <g class="chest-lid">
                            <!-- åœ†å¼§é¡¶ç›– -->
                            <path d="M 48 120 Q 48 65 120 60 Q 192 65 192 120" 
                                  fill="none" stroke="#5D4E37" stroke-width="3"/>
                            <!-- æµ…æ£•è‰²å†…å±‚å¼§çº¿ -->
                            <path d="M 50 120 L 50 123 Q 50 70 120 65 Q 190 70 190 123 L 190 120" 
                                  fill="none" stroke="#5D4E37" stroke-width="2"/>
                            
                            <!-- ç›–å­åº•éƒ¨å°å£çº¿ -->
                            <line x1="48" y1="120" x2="192" y2="120" stroke="#5D4E37" stroke-width="3"/>
                            
                            <!-- é¡¶ç›–æœ¨æ¿æ¡çº¹ -->
                            <path d="M 66 122 Q 66 73 120 68" fill="none" stroke="#8b7355" stroke-width="2"/>
                            <path d="M 84 123 Q 84 71 120 66" fill="none" stroke="#8b7355" stroke-width="2"/>
                            <path d="M 102 124 Q 102 70 120 65" fill="none" stroke="#8b7355" stroke-width="2"/>
                            <path d="M 138 124 Q 138 70 120 65" fill="none" stroke="#8b7355" stroke-width="2"/>
                            <path d="M 156 123 Q 156 71 120 66" fill="none" stroke="#8b7355" stroke-width="2"/>
                            <path d="M 174 122 Q 174 73 120 68" fill="none" stroke="#8b7355" stroke-width="2"/>
                            
                            <!-- é‡‘å±è¾¹æ¡†ï¼ˆé¡¶ç›–ï¼‰ -->
                            <path d="M 48 120 Q 48 63 120 58 Q 192 63 192 120" 
                                  fill="none" stroke="#C9A961" stroke-width="3"/>
                            
                            <!-- å®çŸ³è£…é¥°å¸¦ -->
                            <rect x="54" y="105" width="132" height="12" rx="2" 
                                  fill="none" stroke="#C9A961" stroke-width="2"/>
                            <!-- å®çŸ³ -->
                            <circle cx="70" cy="111" r="3" fill="none" stroke="#8b7355" stroke-width="1.5"/>
                            <circle cx="87" cy="111" r="3" fill="none" stroke="#8b7355" stroke-width="1.5"/>
                            <circle cx="104" cy="111" r="3" fill="none" stroke="#8b7355" stroke-width="1.5"/>
                            <circle cx="120" cy="111" r="3" fill="none" stroke="#8b7355" stroke-width="1.5"/>
                            <circle cx="136" cy="111" r="3" fill="none" stroke="#8b7355" stroke-width="1.5"/>
                            <circle cx="153" cy="111" r="3" fill="none" stroke="#8b7355" stroke-width="1.5"/>
                            <circle cx="170" cy="111" r="3" fill="none" stroke="#8b7355" stroke-width="1.5"/>
                            
                            <!-- é¡¶éƒ¨é‡‘å±ç® -->
                            <path d="M 48 90 Q 48 63 120 58 Q 192 63 192 90" 
                                  fill="none" stroke="#C9A961" stroke-width="3"/>
                            <!-- é“†é’‰ -->
                            <circle cx="55" cy="90" r="3" fill="#C9A961"/>
                            <circle cx="77" cy="87" r="3" fill="#C9A961"/>
                            <circle cx="99" cy="85" r="3" fill="#C9A961"/>
                            <circle cx="120" cy="84" r="3" fill="#C9A961"/>
                            <circle cx="141" cy="85" r="3" fill="#C9A961"/>
                            <circle cx="163" cy="87" r="3" fill="#C9A961"/>
                            <circle cx="185" cy="90" r="3" fill="#C9A961"/>
                            
                            <!-- é¡¶éƒ¨è£…é¥° -->
                            <path d="M 115 72 L 120 64 L 125 72" fill="none" stroke="#C9A961" stroke-width="2"/>
                            <circle cx="120" cy="76" r="3" fill="none" stroke="#C9A961" stroke-width="1.5"/>
                        </g>
                    </svg>
                </div>
            `;
            
            if (treasures.length === 0) {
                content.innerHTML = `
                    <div class="treasure-box-frame">
                        ${illustration}
                    </div>
                    <div class="empty-state">è¿™é‡Œè¿˜å¾ˆå®‰é™ã€‚</div>
                    <button class="primary-button" onclick="showPage('record')">å¼€å§‹è®°å½•</button>
                    <div class="treasure-count">å®è—æ€»æ•°ï¼š0</div>
                `;
            } else {
                content.innerHTML = `
                    <div class="treasure-box-frame">
                        ${illustration}
                    </div>
                    <button class="primary-button" id="drawBtn" onclick="drawTreasure()">éšæœºæŠ½å–å®è—</button>
                    <div class="treasure-count">å®è—æ€»æ•°ï¼š${treasures.length}</div>
                `;
            }
            
            // ç”Ÿæˆç²’å­æ•ˆæœ
            setTimeout(() => {
                initTreasureParticles();
            }, 100);
        }

        // ç”Ÿæˆå®ç®±ä¸Šå‡å…‰ç‚¹ç²’å­
        function initTreasureParticles() {
            const container = document.getElementById('treasureParticles');
            if (!container) return;
            
            // æ¸…ç©ºç°æœ‰ç²’å­
            container.innerHTML = '';
            
            // å·¦ä¾§ç²’å­ï¼ˆè¾ƒå°‘ï¼‰- æ€»å…±15ä¸ª
            // åœ†å½¢ç²’å­ - é‡‘è‰² (7ä¸ª) - å·¦ä¾§
            for (let i = 0; i < 7; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-circle particle-gold';
                particle.style.left = `${10 + Math.random() * 25}%`; // 10%-35%
                particle.style.bottom = `${25 + Math.random() * 15}%`; // 25%-40%
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
            
            // åœ†å½¢ç²’å­ - æ·±æ£•è‰² (4ä¸ª) - å·¦ä¾§
            for (let i = 0; i < 4; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-circle particle-brown';
                particle.style.left = `${10 + Math.random() * 25}%`; // 10%-35%
                particle.style.bottom = `${25 + Math.random() * 15}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3.5 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
            
            // å››è§’æ˜Ÿç²’å­ (2ä¸ª) - å·¦ä¾§
            for (let i = 0; i < 2; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-star';
                particle.style.left = `${12 + Math.random() * 20}%`; // 12%-32%
                particle.style.bottom = `${28 + Math.random() * 12}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2.5}s`;
                container.appendChild(particle);
            }
            
            // ç¬¦æ–‡ç²’å­ (2ä¸ª) - å·¦ä¾§
            const runesLeft = ['áš±', 'áš¹'];
            for (let i = 0; i < 2; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-rune';
                particle.style.left = `${15 + Math.random() * 18}%`; // 15%-33%
                particle.style.bottom = `${26 + Math.random() * 14}%`;
                particle.textContent = runesLeft[i];
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${4 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
            
            // ç®±ç›–åº•éƒ¨ä¸­é—´ç²’å­ - æ€»å…±10ä¸ªï¼ˆæ–°å¢ï¼‰
            // åœ†å½¢ç²’å­ - é‡‘è‰² (4ä¸ª) - ä¸­é—´é¡¶éƒ¨
            for (let i = 0; i < 4; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-circle particle-gold';
                particle.style.left = `${43 + Math.random() * 14}%`; // 43%-57%ï¼ˆä¸­é—´ä½ç½®ï¼‰
                particle.style.bottom = `${45 + Math.random() * 10}%`; // 45%-55%ï¼ˆç®±ç›–åº•éƒ¨ï¼‰
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
            
            // åœ†å½¢ç²’å­ - æ·±æ£•è‰² (3ä¸ª) - ä¸­é—´é¡¶éƒ¨
            for (let i = 0; i < 3; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-circle particle-brown';
                particle.style.left = `${43 + Math.random() * 14}%`;
                particle.style.bottom = `${45 + Math.random() * 10}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3.5 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
            
            // å››è§’æ˜Ÿç²’å­ (2ä¸ª) - ä¸­é—´é¡¶éƒ¨
            for (let i = 0; i < 2; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-star';
                particle.style.left = `${45 + Math.random() * 10}%`;
                particle.style.bottom = `${47 + Math.random() * 8}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2.5}s`;
                container.appendChild(particle);
            }
            
            // ç¬¦æ–‡ç²’å­ (1ä¸ª) - ä¸­é—´é¡¶éƒ¨
            const particle = document.createElement('div');
            particle.className = 'particle-rising particle-rune';
            particle.style.left = `${47 + Math.random() * 6}%`;
            particle.style.bottom = `${48 + Math.random() * 7}%`;
            particle.textContent = 'á›';
            particle.style.animationDelay = `${Math.random() * 5}s`;
            particle.style.animationDuration = `${4 + Math.random() * 2}s`;
            container.appendChild(particle);
            
            // å³ä¾§ç²’å­ï¼ˆè¾ƒå¤šï¼Œä»ç®±ç›–æ•£å‡ºï¼‰- æ€»å…±33ä¸ª
            // åœ†å½¢ç²’å­ - é‡‘è‰² (15ä¸ª) - å³ä¾§ï¼Œå¯†é›†
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-circle particle-gold';
                // é›†ä¸­åœ¨å³ä¾§ç®±ç›–ä½ç½®ï¼š65%-90%
                particle.style.left = `${65 + Math.random() * 25}%`;
                // ä»ç®±ç›–é«˜åº¦å¼€å§‹ï¼š30%-45%
                particle.style.bottom = `${30 + Math.random() * 15}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
            
            // åœ†å½¢ç²’å­ - æ·±æ£•è‰² (10ä¸ª) - å³ä¾§
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-circle particle-brown';
                particle.style.left = `${65 + Math.random() * 25}%`;
                particle.style.bottom = `${30 + Math.random() * 15}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3.5 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
            
            // å››è§’æ˜Ÿç²’å­ (8ä¸ª) - å³ä¾§ï¼Œä»ç®±ç›–æ•£å‡º
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-star';
                particle.style.left = `${68 + Math.random() * 22}%`;
                particle.style.bottom = `${32 + Math.random() * 13}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2.5}s`;
                container.appendChild(particle);
            }
            
            // ç¬¦æ–‡ç²’å­ (6ä¸ª) - å³ä¾§
            const runesRight = ['á›–', 'áš¾', 'á›', 'áš±', 'á›–', 'áš¨'];
            for (let i = 0; i < 6; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-rising particle-rune';
                particle.style.left = `${67 + Math.random() * 20}%`;
                particle.style.bottom = `${31 + Math.random() * 14}%`;
                particle.textContent = runesRight[i];
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.animationDuration = `${4 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
        }

        // æŠ½å–å®è—
        async function drawTreasure() {
            if (treasures.length === 0) {
                showToast('å®ç®±æ˜¯ç©ºçš„');
                return;
            }

            // 1. ç‚¹å‡»æŒ‰é’®éŸ³æ•ˆï¼ˆé»‘è½´ï¼‰
            AudioSystem.playButtonClick();
            
            showPage('draw');
            
            // 2. æ’­æ”¾å®ç®±æ‰“å¼€éŸ³æ•ˆ
            AudioSystem.playChestOpen();
            
            // 3. ç­‰å¾…1.5ç§’åæ˜¾ç¤ºå®è—
            await sleep(1500);
            
            const randomIndex = Math.floor(Math.random() * treasures.length);
            currentTreasure = treasures[randomIndex];
            showTreasureCard(currentTreasure);
        }

        // æ˜¾ç¤ºå®è—å¡
        function showTreasureCard(treasure) {
            // éšæœºé€‰æ‹©é­”æ³•é˜µç±»å‹ï¼ˆ1,2,3,6ï¼‰
            const circleTypes = [1, 2, 3, 6];
            const circleType = circleTypes[Math.floor(Math.random() * circleTypes.length)];
            
            const modal = document.getElementById('treasureCardModal');
            modal.innerHTML = `
                <button class="modal-close-btn" onclick="closeModal()">Ã—</button>
                <div class="treasure-card-icon" onclick="generateStickerFromIcon()" style="cursor: pointer;" title="ç‚¹å‡»ç”Ÿæˆç®€çº¦ç‰ˆè´´çº¸">
                    <div class="magic-circle-container ${getCircleClassName(circleType)}" data-circle-type="${circleType}">
                        ${getCircleHTML(circleType)}
                        <div class="particles-container" id="card-particles"></div>
                        ${getTreasureSVG(treasure.name)}
                    </div>
                </div>
                <div class="treasure-card-name">${treasure.name}</div>
                <div class="treasure-card-content">${treasure.content}</div>
                <div class="preview-treasure-meta">
                    <span class="preview-emotion-tag">
                        <span class="emotion-icon ${treasure.emotion}"></span>
                        ${treasure.emotion}
                    </span>
                    <span class="preview-treasure-time">${treasure.time}</span>
                </div>
                <div class="preview-crow-comment">"${treasure.comment}"</div>
                <div class="treasure-card-actions">
                    <button class="icon-btn share-icon" onclick="openSharePanel()" title="åˆ†äº«">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.5" y1="13.5" x2="15.5" y2="17.5"/>
                            <line x1="8.5" y1="10.5" x2="15.5" y2="6.5"/>
                        </svg>
                    </button>
                    <button class="icon-btn download-icon" onclick="downloadTreasureCard()" title="ä¿å­˜å›¾ç‰‡">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                    <button class="icon-btn delete-icon" onclick="confirmDelete(${treasure.id})" title="åˆ é™¤">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // åˆ›å»ºç²’å­æ•ˆæœ
            setTimeout(() => createParticles('card'), 0);
            
            document.getElementById('overlay').classList.add('active');
            modal.classList.add('active');
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            const sharePanel = document.getElementById('sharePanel');
            
            // å…³é—­å›¾ç‰‡é¢„è§ˆï¼ˆå¦‚æœæœ‰ï¼‰
            closeImagePreview();
            
            // å¦‚æœåˆ†äº«é¢æ¿æ˜¯æ‰“å¼€çš„ï¼Œå…ˆå…³é—­åˆ†äº«é¢æ¿
            if (sharePanel && sharePanel.classList.contains('active')) {
                closeSharePanel();
                return;
            }
            
            const overlay = document.getElementById('overlay');
            const treasureCardModal = document.getElementById('treasureCardModal');
            const treasurePreviewModal = document.getElementById('treasurePreviewModal');
            
            // å¦‚æœæ˜¯ä»æŠ½å–é¡µé¢å…³é—­å®è—å¡ï¼Œç«‹å³è¿”å›å®ç®±é¡µé¢
            const isDrawPage = document.getElementById('drawPage').classList.contains('active');
            if (isDrawPage && treasureCardModal.classList.contains('active')) {
                // ç«‹å³è·³è½¬åˆ°å®ç®±é¡µé¢
                showPage('treasureBox');
            }
            
            // å…³é—­å¼¹çª—
            overlay.classList.remove('active');
            treasureCardModal.classList.remove('active');
            treasurePreviewModal.classList.remove('active');
        }

        // ç¡®è®¤åˆ é™¤
        function confirmDelete(id) {
            showConfirm('ç§»é™¤å®è—', 'ç¡®å®šè¦å°†è¿™ä¸ªå®è—ç§»é™¤å—ï¼Ÿ', () => {
                deleteTreasure(id);
            });
        }

        // åˆ é™¤å®è—
        function deleteTreasure(id) {
            AudioSystem.playDelete(); // æ’­æ”¾åˆ é™¤éŸ³æ•ˆ
            
            treasures = treasures.filter(t => t.id !== id);
            saveTreasures();
            
            // å…ˆå…³é—­æ‰€æœ‰å¼¹çª—
            const overlay = document.getElementById('overlay');
            const treasureCardModal = document.getElementById('treasureCardModal');
            const confirmDialog = document.getElementById('confirmDialog');
            
            overlay.classList.remove('active');
            treasureCardModal.classList.remove('active');
            confirmDialog.classList.remove('active');
            
            // å»¶è¿Ÿåè¿”å›å®ç®±é¡µé¢å¹¶æ˜¾ç¤ºæç¤º
            setTimeout(() => {
                showPage('treasureBox');
                showToast('å·²ç§»é™¤');
                updateTreasureBox();
                updateProfileCount();
            }, 200);
        }

        // ç¡®è®¤æ¸…ç©º
        function confirmClearAll() {
            if (treasures.length === 0) {
                showToast('å®ç®±å·²ç»æ˜¯ç©ºçš„äº†');
                return;
            }
            showConfirm('æ¸…ç©ºå®è—', 'æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚\nè¯·è°¨æ…æ“ä½œã€‚', () => {
                treasures = [];
                saveTreasures();
                showToast('å·²æ¸…ç©º');
                updateTreasureBox();
                updateProfileCount();
            }, true);
        }

        // åˆ‡æ¢éŸ³ä¹
        function toggleMusic() {
            AudioSystem.playButtonClick();
            const isMuted = AudioSystem.toggleMute();
            const iconBtn = document.getElementById('musicIconBtn');
            
            if (isMuted) {
                iconBtn.classList.add('muted');
                showToast('éŸ³ä¹å·²å…³é—­');
            } else {
                iconBtn.classList.remove('muted');
                showToast('éŸ³ä¹å·²å¼€å¯');
            }
        }

        // åˆ‡æ¢äº¤äº’éŸ³æ•ˆ
        let sfxMuted = false;
        function toggleSFX() {
            AudioSystem.playButtonClick();
            sfxMuted = !sfxMuted;
            const iconBtn = document.getElementById('sfxIconBtn');
            
            if (sfxMuted) {
                iconBtn.classList.add('muted');
                AudioSystem.sfxVolume = 0;
                showToast('éŸ³æ•ˆå·²å…³é—­');
            } else {
                iconBtn.classList.remove('muted');
                const slider = document.getElementById('sfxVolumeSlider');
                AudioSystem.sfxVolume = slider.value / 100;
                showToast('éŸ³æ•ˆå·²å¼€å¯');
            }
        }

        // æ›´æ–°éŸ³é‡
        function updateVolume(value) {
            const volume = value / 100;
            AudioSystem.setVolume(volume);
            document.getElementById('volumeValue').textContent = value + '%';
            
            // è‡ªåŠ¨å–æ¶ˆé™éŸ³
            if (value > 0) {
                const iconBtn = document.getElementById('musicIconBtn');
                iconBtn.classList.remove('muted');
            }
        }

        // æ›´æ–°äº¤äº’éŸ³æ•ˆéŸ³é‡
        function updateSFXVolume(value) {
            if (!sfxMuted) {
                AudioSystem.sfxVolume = value / 100;
            }
            document.getElementById('sfxVolumeValue').textContent = value + '%';
            
            // è‡ªåŠ¨å–æ¶ˆé™éŸ³
            if (value > 0) {
                const iconBtn = document.getElementById('sfxIconBtn');
                iconBtn.classList.remove('muted');
                sfxMuted = false;
            }
        }

        // æ˜¾ç¤ºå…³äº
        function showAbout() {
            showConfirm('å…³äº', "ä¹Œé¸¦çš„å®è— v1.2 (å¼€å‘è€…ç‰ˆ)\n\nä¸€ä¸ªè®°å½•ä¸é‡æ‹¾å†…å¿ƒå®è—çš„å·¥å…·ã€‚\nå†…ç½®AIå¢å¼ºåŠŸèƒ½ã€‚", null, false, 'çŸ¥é“äº†');
        }

        // ==================== API Keyå¯¹è¯æ¡†ç›¸å…³å‡½æ•°å·²ç§»é™¤ - å¼€å‘è€…æ¨¡å¼ ====================

        // æ›´æ–°ç»Ÿè®¡
        function updateProfileCount() {
            // æ›´æ–°å®è—æ€»æ•°
            document.getElementById('profileTreasureCount').textContent = treasures.length;
            
            // è®¡ç®—è®°å½•å¤©æ•°
            const recordDays = calculateRecordDays();
            document.getElementById('profileRecordDays').textContent = recordDays;
        }
        
        // è®¡ç®—è®°å½•å¤©æ•°ï¼ˆä»ç¬¬ä¸€æ¬¡è®°å½•å¼€å§‹åˆ°ç°åœ¨çš„æ€»å¤©æ•°ï¼‰
        function calculateRecordDays() {
            if (treasures.length === 0) return 0;
            
            // æ‰¾åˆ°æœ€æ—©çš„å®è—æ—¶é—´æˆ³
            let earliestTimestamp = treasures[0].timestamp;
            
            treasures.forEach(treasure => {
                if (treasure.timestamp && treasure.timestamp < earliestTimestamp) {
                    earliestTimestamp = treasure.timestamp;
                }
            });
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ—¶é—´æˆ³ï¼Œè¿”å›0
            if (!earliestTimestamp) return 0;
            
            // è®¡ç®—ä»æœ€æ—©è®°å½•æ—¥æœŸåˆ°ä»Šå¤©çš„å¤©æ•°å·®
            const firstDate = new Date(earliestTimestamp);
            const today = new Date();
            
            // å°†æ—¶é—´è®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹ï¼ˆ0æ—¶0åˆ†0ç§’ï¼‰ï¼Œä»¥ä¾¿å‡†ç¡®è®¡ç®—å¤©æ•°å·®
            firstDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            // è®¡ç®—å¤©æ•°å·®ï¼ˆæ¯«ç§’å·® / æ¯å¤©çš„æ¯«ç§’æ•°ï¼‰
            const daysDiff = Math.floor((today - firstDate) / (1000 * 60 * 60 * 24));
            
            // è¿”å›å¤©æ•°+1ï¼ˆå› ä¸ºç¬¬ä¸€å¤©ä¹Ÿç®—ä¸€å¤©ï¼‰
            return daysDiff + 1;
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(pageName) {
            // å…³é—­å›¾ç‰‡é¢„è§ˆï¼ˆå¦‚æœæœ‰ï¼‰
            closeImagePreview();
            
            // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆï¼ˆé™¤äº†drawé¡µé¢ï¼Œå› ä¸ºdrawé¡µé¢åœ¨drawTreasureä¸­å·²ç»æ’­æ”¾äº†ï¼‰
            if (pageName !== 'draw') {
                AudioSystem.playButtonClick();
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            
            const pageMap = {
                'record': ['recordPage', 0],
                'treasureBox': ['treasureBoxPage', 1],
                'draw': ['drawPage', -1],
                'profile': ['profilePage', 2]
            };
            
            const [pageId, tabIndex] = pageMap[pageName];
            document.getElementById(pageId).classList.add('active');
            
            if (tabIndex >= 0) {
                document.querySelectorAll('.tab-item')[tabIndex].classList.add('active');
            }
        }

        // ç¡®è®¤å¯¹è¯æ¡†
        function showConfirm(title, message, onConfirm, isDanger = false, confirmText = 'ç¡®å®š') {
            const dialog = document.getElementById('confirmDialog');
            const cancelBtn = onConfirm ? `<button class="confirm-btn cancel" onclick="closeConfirm()">å–æ¶ˆ</button>` : '';
            const confirmClass = isDanger ? 'danger' : 'confirm';
            
            dialog.innerHTML = `
                <div class="confirm-title">${title}</div>
                <div class="confirm-message">${message}</div>
                <div class="confirm-buttons">
                    ${cancelBtn}
                    <button class="confirm-btn ${confirmClass}" onclick="handleConfirm()">${confirmText}</button>
                </div>
            `;
            
            dialog.classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            window.currentConfirmAction = onConfirm;
        }

        function handleConfirm() {
            if (window.currentConfirmAction) {
                window.currentConfirmAction();
            }
            closeConfirm();
        }

        function closeConfirm() {
            document.getElementById('confirmDialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            window.currentConfirmAction = null;
        }

        // Toastæç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ==================== åˆ†äº«åŠŸèƒ½ ====================
        
        // æ‰“å¼€åˆ†äº«é¢æ¿
        function openSharePanel() {
            const sharePanel = document.getElementById('sharePanel');
            const shareOverlay = document.getElementById('shareOverlay');
            
            shareOverlay.classList.add('active');
            sharePanel.classList.add('active');
        }
        
        // å…³é—­åˆ†äº«é¢æ¿
        function closeSharePanel() {
            const sharePanel = document.getElementById('sharePanel');
            const shareOverlay = document.getElementById('shareOverlay');
            
            sharePanel.classList.remove('active');
            shareOverlay.classList.remove('active');
        }
        
        // æˆªå›¾å¹¶æ˜¾ç¤ºå®è—å¡å›¾ç‰‡ï¼ˆä¾›ç”¨æˆ·é•¿æŒ‰ä¿å­˜ï¼‰
        async function downloadTreasureCard() {
            // ç›´æ¥ç”Ÿæˆå®Œæ•´ç‰ˆæ˜ä¿¡ç‰‡
            try {
                const treasureCard = document.querySelector('.treasure-card-modal.active') || 
                                   document.querySelector('.treasure-preview-modal.active');
                
                if (!treasureCard) {
                    showToast('æœªæ‰¾åˆ°å®è—å¡');
                    return;
                }
                
                // æå–å®è—æ•°æ®
                const treasureData = extractTreasureData(treasureCard);
                
                // ç”Ÿæˆå®Œæ•´ç‰ˆæ˜ä¿¡ç‰‡
                await generatePostcardImage(treasureData, 'full');
                
            } catch (error) {
                console.error('ç”Ÿæˆæ˜ä¿¡ç‰‡å¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ç‚¹å‡»å®è—å›¾æ ‡ç”Ÿæˆç®€çº¦ç‰ˆè´´çº¸
        async function generateStickerFromIcon() {
            try {
                const treasureCard = document.querySelector('.treasure-card-modal.active') || 
                                   document.querySelector('.treasure-preview-modal.active');
                
                if (!treasureCard) {
                    showToast('æœªæ‰¾åˆ°å®è—å¡');
                    return;
                }
                
                // æå–å®è—æ•°æ®
                const treasureData = extractTreasureData(treasureCard);
                
                // ç”Ÿæˆç®€çº¦ç‰ˆæ˜ä¿¡ç‰‡ï¼ˆè´´çº¸ï¼‰
                await generatePostcardImage(treasureData, 'minimal');
                
            } catch (error) {
                console.error('ç”Ÿæˆè´´çº¸å¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        
        // æå–å®è—æ•°æ®
        function extractTreasureData(element) {
            // æå–å®è—åç§°
            const nameElem = element.querySelector('.preview-treasure-name, .treasure-card-name');
            const name = nameElem ? nameElem.textContent.trim() : 'æœªå‘½åå®è—';
            
            // æå–å®è—å†…å®¹
            const contentElem = element.querySelector('.preview-treasure-content, .treasure-card-content');
            const content = contentElem ? contentElem.textContent.trim() : '';
            
            // æå–æƒ…ç»ª
            const emotionElem = element.querySelector('.emotion-tag span:last-child, .preview-emotion-tag');
            const emotion = emotionElem ? emotionElem.textContent.trim() : '';
            
            // æå–æ—¶é—´
            const timeElem = element.querySelector('.treasure-card-time, .preview-treasure-time');
            const time = timeElem ? timeElem.textContent.trim() : '';
            
            // æå–ä¹Œé¸¦è¯„è®º
            const crowElem = element.querySelector('.preview-crow-comment, .crow-comment');
            const crowComment = crowElem ? crowElem.textContent.trim() : '';
            
            // æå–å®è—å›¾æ ‡ç±»å‹
            const iconElem = element.querySelector('.treasure-icon svg');
            let iconType = 1; // é»˜è®¤é‡‘å¸
            if (iconElem && iconElem.dataset.type) {
                iconType = parseInt(iconElem.dataset.type);
            }
            
            // æå–é­”æ³•åœˆç±»å‹
            const circleContainer = element.querySelector('.magic-circle-container');
            let circleType = 3; // é»˜è®¤é˜´é˜³èºæ—‹
            if (circleContainer && circleContainer.dataset.circleType) {
                circleType = parseInt(circleContainer.dataset.circleType);
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šé€šè¿‡classåˆ¤æ–­
                const circleElem = element.querySelector('.magic-circle-container');
                if (circleElem) {
                    if (circleElem.classList.contains('circle-classic')) circleType = 1;
                    else if (circleElem.classList.contains('circle-rune')) circleType = 2;
                    else if (circleElem.classList.contains('circle-spiral')) circleType = 3;
                    else if (circleElem.classList.contains('circle-ancient')) circleType = 6;
                }
            }
            
            return {
                name,
                content,
                emotion,
                time,
                crowComment,
                iconType,
                circleType
            };
        }
        
        // ç”Ÿæˆæ˜ä¿¡ç‰‡å›¾ç‰‡
        async function generatePostcardImage(treasureData, version) {
            return new Promise((resolve, reject) => {
                try {
                    console.log('å¼€å§‹ç”Ÿæˆæ˜ä¿¡ç‰‡...', version, treasureData);
                    
                    const width = 300;
                    let height;
                    
                    if (version === 'full') {
                        // å®Œæ•´ç‰ˆï¼šå…ˆè®¡ç®—æ‰€éœ€é«˜åº¦
                        height = calculateFullPostcardHeight(treasureData, width);
                    } else {
                        // ç®€çº¦ç‰ˆï¼šå›ºå®šé«˜åº¦
                        height = 280;
                    }
                    
                    // åˆ›å»ºCanvas
                    const canvas = document.createElement('canvas');
                    const scale = 2; // é«˜æ¸…
                    canvas.width = width * scale;
                    canvas.height = height * scale;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.scale(scale, scale);
                    
                    // ç»˜åˆ¶èƒŒæ™¯
                    ctx.fillStyle = '#E8E4D9';
                    ctx.fillRect(0, 0, width, height);
                    
                    // æ ¹æ®ç‰ˆæœ¬ç»˜åˆ¶
                    if (version === 'full') {
                        drawFullPostcard(ctx, width, height, treasureData);
                    } else {
                        drawMinimalPostcard(ctx, width, height, treasureData);
                    }
                    
                    // è½¬æ¢ä¸ºPNGå¹¶æ˜¾ç¤º
                    canvas.toBlob(imageBlob => {
                        if (imageBlob) {
                            console.log('æ˜ä¿¡ç‰‡ç”ŸæˆæˆåŠŸ');
                            const imageUrl = URL.createObjectURL(imageBlob);
                            showImagePreview(imageUrl);
                            resolve();
                        } else {
                            reject(new Error('PNGç”Ÿæˆå¤±è´¥'));
                        }
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('ç”Ÿæˆæ˜ä¿¡ç‰‡å‡ºé”™:', error);
                    reject(error);
                }
            });
        }
        
        // è®¡ç®—å®Œæ•´ç‰ˆæ˜ä¿¡ç‰‡æ‰€éœ€é«˜åº¦
        function calculateFullPostcardHeight(data, width) {
            // åˆ›å»ºä¸´æ—¶canvasç”¨äºæµ‹é‡
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            let y = 40; // é¡¶éƒ¨è¾¹è·
            
            // 1. å›¾æ¡ˆ+é­”æ³•ç¯
            const circleSize = 100;
            y += circleSize + 8; // å›¾æ¡ˆé«˜åº¦ + 8pxé—´è·
            
            // 2. å®è—åç§°
            y += 35;
            
            // 3. åˆ†å‰²çº¿
            y += 25;
            
            // 4. å®è—å†…å®¹
            if (data.content) {
                ctx.font = '15px "Noto Serif SC", serif';
                const lines = wrapText(ctx, data.content, width - 60);
                y += lines.length * 27 + 10;
                y += 25; // åˆ†å‰²çº¿
            }
            
            // 5. æƒ…ç»ªå’Œæ—¶é—´
            if (data.emotion || data.time) {
                y += 30;
                y += 25; // åˆ†å‰²çº¿
            }
            
            // 6. ä¹Œé¸¦è¯„è®º
            if (data.crowComment) {
                ctx.font = 'italic 13px "Noto Serif SC", serif';
                const commentLines = wrapText(ctx, data.crowComment, width - 60);
                y += commentLines.length * 22;
                y += 36; // åº•éƒ¨å›ºå®š36pxè¾¹è·
            } else {
                y += 36; // å¦‚æœæ²¡æœ‰è¯„è®º,ä¹Ÿä¿æŒåº•éƒ¨è¾¹è·
            }
            
            return Math.max(y, 280); // æœ€å°é«˜åº¦280px
        }
        
        // ç»˜åˆ¶å®Œæ•´ç‰ˆæ˜ä¿¡ç‰‡
        function drawFullPostcard(ctx, width, height, data) {
            const centerX = width / 2;
            let y = 40;
            
            // 1. ç»˜åˆ¶é­”æ³•åœˆå’Œå®è—å›¾æ ‡ï¼ˆç¼©å°å°ºå¯¸ï¼‰
            const circleSize = 100; // ä»140ç¼©å°åˆ°100
            const iconSize = 50;    // ä»70ç¼©å°åˆ°50
            drawMagicCircle(ctx, centerX, y + circleSize/2, circleSize, data.circleType);
            drawTreasureIconSimple(ctx, centerX, y + circleSize/2, iconSize);
            y += circleSize + 8; // å›¾æ¡ˆç»„åˆå+8pxå›ºå®šé—´è·
            
            // 2. ç»˜åˆ¶å®è—åç§°
            ctx.fillStyle = '#3D2F2F';
            ctx.font = 'bold 22px "Noto Serif SC", serif';
            ctx.textAlign = 'center';
            ctx.fillText(data.name, centerX, y);
            y += 35;
            
            // 3. åˆ†å‰²çº¿
            drawDivider(ctx, width, y);
            y += 25;
            
            // 4. ç»˜åˆ¶å®è—å†…å®¹
            if (data.content) {
                ctx.fillStyle = '#5a4a3a';
                ctx.font = '15px "Noto Serif SC", serif';
                const lines = wrapText(ctx, data.content, width - 60);
                lines.forEach(line => {
                    ctx.fillText(line, centerX, y);
                    y += 27;
                });
                y += 10;
                
                // 5. åˆ†å‰²çº¿ï¼ˆå†…å®¹åï¼‰
                drawDivider(ctx, width, y);
                y += 25;
            }
            
            // 6. ç»˜åˆ¶æƒ…ç»ªå’Œæ—¶é—´
            if (data.emotion || data.time) {
                ctx.fillStyle = '#8b7355';
                ctx.font = '13px "Noto Serif SC", serif';
                const metaText = [data.emotion, data.time].filter(Boolean).join('  ');
                ctx.fillText(metaText, centerX, y);
                y += 30;
                
                // 7. åˆ†å‰²çº¿ï¼ˆæƒ…ç»ªåï¼‰
                drawDivider(ctx, width, y);
                y += 25;
            }
            
            // 8. ç»˜åˆ¶ä¹Œé¸¦è¯„è®º
            if (data.crowComment) {
                ctx.fillStyle = '#8b7355';
                ctx.font = 'italic 13px "Noto Serif SC", serif';
                const commentLines = wrapText(ctx, data.crowComment, width - 60);
                commentLines.forEach(line => {
                    ctx.fillText(line, centerX, y);
                    y += 22;
                });
                y += 36; // ä¹Œé¸¦è¯­å½•ä¸‹æ–¹å›ºå®š36pxè¾¹è·
            }
            
            // è¿”å›å®é™…å†…å®¹é«˜åº¦
            return y;
        }
        
        // ç»˜åˆ¶ç®€çº¦ç‰ˆæ˜ä¿¡ç‰‡
        function drawMinimalPostcard(ctx, width, height, data) {
            const centerX = width / 2;
            const centerY = height / 2;
            
            // 1. ç»˜åˆ¶é­”æ³•åœˆå’Œå®è—å›¾æ ‡ï¼ˆç¼©å°å°ºå¯¸ï¼‰
            const circleSize = 90;  // ä»120ç¼©å°åˆ°90
            const iconSize = 45;     // ä»60ç¼©å°åˆ°45
            drawMagicCircle(ctx, centerX, centerY - 40, circleSize, data.circleType);
            drawTreasureIconSimple(ctx, centerX, centerY - 40, iconSize);
            
            // 2. åˆ†å‰²çº¿ï¼ˆå›¾æ¡ˆå’Œæ–‡å­—ä¹‹é—´ï¼‰
            const dividerY = centerY + 30;
            const dividerWidth = width * 0.6;
            const startX = (width - dividerWidth) / 2;
            const endX = startX + dividerWidth;
            
            const gradient = ctx.createLinearGradient(startX, dividerY, endX, dividerY);
            gradient.addColorStop(0, 'rgba(201, 169, 97, 0)');
            gradient.addColorStop(0.5, 'rgba(201, 169, 97, 1)');
            gradient.addColorStop(1, 'rgba(201, 169, 97, 0)');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(startX, dividerY);
            ctx.lineTo(endX, dividerY);
            ctx.stroke();
            
            // 3. ç»˜åˆ¶å®è—åç§°
            ctx.fillStyle = '#3D2F2F';
            ctx.font = '600 18px "Noto Serif SC", serif';
            ctx.textAlign = 'center';
            ctx.fillText(data.name, centerX, centerY + 60);
        }
        
        // ç»˜åˆ¶åˆ†å‰²çº¿
        function drawDivider(ctx, totalWidth, y, startX) {
            startX = startX || totalWidth * 0.1;
            const endX = startX + (totalWidth * 0.8);
            
            const gradient = ctx.createLinearGradient(startX, y, endX, y);
            gradient.addColorStop(0, 'rgba(201, 169, 97, 0)');
            gradient.addColorStop(0.5, 'rgba(201, 169, 97, 1)');
            gradient.addColorStop(1, 'rgba(201, 169, 97, 0)');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(startX, y);
            ctx.lineTo(endX, y);
            ctx.stroke();
        }
        
        // ç»˜åˆ¶é­”æ³•åœˆï¼ˆé™æ€ç‰ˆæœ¬ï¼‰
        function drawMagicCircle(ctx, x, y, size, type) {
            const radius = size / 2;
            ctx.strokeStyle = '#C9A961';
            ctx.fillStyle = '#C9A961';
            
            switch(type) {
                case 1: // ç»å…¸å…­èŠ’æ˜Ÿ
                    // å¤–åœ†
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // å†…åœ†
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, radius * 0.7, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // å…­ä¸ªç‚¹
                    const dotPositions = [
                        [0, -radius - 4],
                        [0, radius + 4],
                        [-radius - 4, 0],
                        [radius + 4, 0],
                        [radius * 0.6, -radius * 0.6],
                        [-radius * 0.6, radius * 0.6]
                    ];
                    dotPositions.forEach(([dx, dy]) => {
                        ctx.beginPath();
                        ctx.arc(x + dx, y + dy, 4, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    break;
                    
                case 2: // ç¬¦æ–‡ä¸‰ç¯
                    ctx.lineWidth = 2;
                    [1, 0.75, 0.5].forEach(scale => {
                        ctx.beginPath();
                        ctx.arc(x, y, radius * scale, 0, Math.PI * 2);
                        ctx.stroke();
                    });
                    
                    // ç¬¦æ–‡ç¬¦å·
                    ctx.font = '20px serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const runes = ['áš›', 'ášœ', 'áš‘', 'áš'];
                    const runePos = [[0, -radius - 10], [0, radius + 10], [-radius - 10, 0], [radius + 10, 0]];
                    runes.forEach((rune, i) => {
                        ctx.fillText(rune, x + runePos[i][0], y + runePos[i][1]);
                    });
                    break;
                    
                case 3: // é˜´é˜³èºæ—‹
                    ctx.lineWidth = 2;
                    // å¤–åœ†ä¸ŠåŠ
                    ctx.beginPath();
                    ctx.arc(x, y, radius, Math.PI, Math.PI * 2);
                    ctx.stroke();
                    // å¤–åœ†ä¸‹åŠ
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI);
                    ctx.stroke();
                    // å†…åœ†ä¸ŠåŠ
                    ctx.beginPath();
                    ctx.arc(x, y, radius * 0.7, Math.PI, Math.PI * 2);
                    ctx.stroke();
                    // å†…åœ†ä¸‹åŠ
                    ctx.beginPath();
                    ctx.arc(x, y, radius * 0.7, 0, Math.PI);
                    ctx.stroke();
                    break;
                    
                case 6: // å¤æ–‡å°å°
                    // åŒçº¿å¤–åœ†
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // å†…åœ†
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, radius * 0.6, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // å¤æ–‡ç¬¦å·
                    ctx.font = 'bold 24px serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const symbols = ['å', 'å', 'â˜°', 'â˜·'];
                    const symPos = [[0, -radius - 15], [0, radius + 15], [-radius - 15, 0], [radius + 15, 0]];
                    symbols.forEach((sym, i) => {
                        ctx.fillText(sym, x + symPos[i][0], y + symPos[i][1]);
                    });
                    break;
            }
        }
        
        // ç®€åŒ–çš„å®è—å›¾æ ‡ç»˜åˆ¶ï¼ˆç¤ºä¾‹ï¼šé‡‘å¸ï¼‰
        function drawTreasureIconSimple(ctx, x, y, size) {
            const radius = size / 2.5;
            
            // å¤–åœ†
            ctx.fillStyle = '#C9A961';
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#8B6F47';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // å†…åœ†
            ctx.strokeStyle = '#8B6F47';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, radius * 0.8, 0, Math.PI * 2);
            ctx.stroke();
            
            // Â¥ ç¬¦å·
            ctx.fillStyle = '#8B6F47';
            ctx.font = `bold ${size * 0.35}px serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Â¥', x, y + size * 0.05);
        }
        
        // æ–‡æœ¬æ¢è¡Œè¾…åŠ©å‡½æ•°
        function wrapText(ctx, text, maxWidth) {
            const chars = text.split('');
            const lines = [];
            let currentLine = '';
            
            for (let char of chars) {
                const testLine = currentLine + char;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine = testLine;
                }
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines;
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆä¾›ç”¨æˆ·é•¿æŒ‰ä¿å­˜ï¼‰
        function showImagePreview(imageUrl) {
            // å¦‚æœå·²ç»æœ‰é¢„è§ˆï¼Œå…ˆå…³é—­
            closeImagePreview();
            
            // åˆ›å»ºå›¾ç‰‡é¢„è§ˆé®ç½©
            const previewOverlay = document.createElement('div');
            previewOverlay.id = 'imagePreviewOverlay';
            previewOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 1000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            `;
            
            // æç¤ºæ–‡å­—
            const tipText = document.createElement('div');
            tipText.textContent = 'é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ';
            tipText.style.cssText = `
                color: white;
                font-size: 16px;
                margin-bottom: 20px;
                text-align: center;
                letter-spacing: 1px;
            `;
            
            // å›¾ç‰‡
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 60vh;
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            `;
            
            // ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'ä¸‹è½½å›¾ç‰‡';
            downloadBtn.style.cssText = `
                margin-top: 20px;
                padding: 12px 32px;
                background: #8b7355;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                letter-spacing: 1px;
                transition: all 0.2s;
            `;
            
            downloadBtn.onclick = async () => {
                try {
                    // ä»imageUrlè·å–blob
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const downloadLink = document.createElement('a');
                    const timestamp = new Date().getTime();
                    downloadLink.href = URL.createObjectURL(blob);
                    downloadLink.download = `ä¹Œé¸¦çš„å®è—_${timestamp}.png`;
                    
                    // è§¦å‘ä¸‹è½½
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    // é‡Šæ”¾URL
                    URL.revokeObjectURL(downloadLink.href);
                    
                    showToast('å›¾ç‰‡å·²ä¸‹è½½');
                } catch (error) {
                    console.error('ä¸‹è½½å¤±è´¥:', error);
                    showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜');
                }
            };
            
            // å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Ã—';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
                border: none;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                font-size: 28px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            `;
            
            closeBtn.onclick = () => {
                closeImagePreview();
            };
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            previewOverlay.onclick = (e) => {
                if (e.target === previewOverlay) {
                    closeImagePreview();
                }
            };
            
            previewOverlay.appendChild(closeBtn);
            previewOverlay.appendChild(tipText);
            previewOverlay.appendChild(img);
            previewOverlay.appendChild(downloadBtn);
            document.body.appendChild(previewOverlay);
            
            // ä¿å­˜imageUrlä¾›æ¸…ç†æ—¶ä½¿ç”¨
            previewOverlay.dataset.imageUrl = imageUrl;
            
            showToast('å›¾ç‰‡å·²ç”Ÿæˆ');
            closeSharePanel();
        }
        
        // å…³é—­å›¾ç‰‡é¢„è§ˆ
        function closeImagePreview() {
            const previewOverlay = document.getElementById('imagePreviewOverlay');
            if (previewOverlay) {
                const imageUrl = previewOverlay.dataset.imageUrl;
                if (imageUrl) {
                    URL.revokeObjectURL(imageUrl);
                }
                document.body.removeChild(previewOverlay);
            }
        }
        
        // åˆ†äº«åˆ°å¾®ä¿¡
        async function shareToWechat() {
            try {
                const treasureCard = document.querySelector('.treasure-card-modal.active') || 
                                   document.querySelector('.treasure-preview-modal.active');
                
                if (!treasureCard) {
                    showToast('æœªæ‰¾åˆ°å®è—å¡');
                    return;
                }
                
                // ä¸´æ—¶éšè—æŒ‰é’®
                const closeBtn = treasureCard.querySelector('.modal-close-btn, .modal-close');
                const actionsBar = treasureCard.querySelector('.treasure-card-actions');
                const previewActions = treasureCard.querySelector('.preview-actions');
                
                const elementsToHide = [closeBtn, actionsBar, previewActions].filter(el => el);
                elementsToHide.forEach(el => el.style.display = 'none');
                
                // ç”Ÿæˆå›¾ç‰‡
                await generateCardImage(treasureCard);
                
                elementsToHide.forEach(el => el.style.display = '');
                
                showToast('å›¾ç‰‡å·²ç”Ÿæˆï¼Œé•¿æŒ‰ä¿å­˜ååˆ†äº«åˆ°å¾®ä¿¡');
                
            } catch (error) {
                console.error('åˆ†äº«å¤±è´¥:', error);
                showToast('è¯·å…ˆä¿å­˜å›¾ç‰‡ï¼Œç„¶åæ‰‹åŠ¨åˆ†äº«');
            }
        }
        
        // åˆ†äº«åˆ°å°çº¢ä¹¦
        async function shareToXiaohongshu() {
            try {
                const treasureCard = document.querySelector('.treasure-card-modal.active') || 
                                   document.querySelector('.treasure-preview-modal.active');
                
                if (!treasureCard) {
                    showToast('æœªæ‰¾åˆ°å®è—å¡');
                    return;
                }
                
                // ä¸´æ—¶éšè—æŒ‰é’®
                const closeBtn = treasureCard.querySelector('.modal-close-btn, .modal-close');
                const actionsBar = treasureCard.querySelector('.treasure-card-actions');
                const previewActions = treasureCard.querySelector('.preview-actions');
                
                const elementsToHide = [closeBtn, actionsBar, previewActions].filter(el => el);
                elementsToHide.forEach(el => el.style.display = 'none');
                
                // ç”Ÿæˆå›¾ç‰‡
                await generateCardImage(treasureCard);
                
                elementsToHide.forEach(el => el.style.display = '');
                
                showToast('å›¾ç‰‡å·²ç”Ÿæˆï¼Œé•¿æŒ‰ä¿å­˜åå‘å¸ƒåˆ°å°çº¢ä¹¦');
                
            } catch (error) {
                console.error('åˆ†äº«å¤±è´¥:', error);
                showToast('è¯·å…ˆä¿å­˜å›¾ç‰‡ï¼Œç„¶åæ‰‹åŠ¨åˆ†äº«');
            }
        }
        
        // åˆ†äº«åˆ°QQ
        async function shareToQQ() {
            try {
                const treasureCard = document.querySelector('.treasure-card-modal.active') || 
                                   document.querySelector('.treasure-preview-modal.active');
                
                if (!treasureCard) {
                    showToast('æœªæ‰¾åˆ°å®è—å¡');
                    return;
                }
                
                const closeBtn = treasureCard.querySelector('.modal-close-btn, .modal-close');
                const actionsBar = treasureCard.querySelector('.treasure-card-actions');
                const previewActions = treasureCard.querySelector('.preview-actions');
                
                const elementsToHide = [closeBtn, actionsBar, previewActions].filter(el => el);
                elementsToHide.forEach(el => el.style.display = 'none');
                
                // ç”Ÿæˆå›¾ç‰‡
                await generateCardImage(treasureCard);
                
                elementsToHide.forEach(el => el.style.display = '');
                
                showToast('å›¾ç‰‡å·²ç”Ÿæˆï¼Œé•¿æŒ‰ä¿å­˜ååˆ†äº«åˆ°QQ');
                
            } catch (error) {
                console.error('åˆ†äº«å¤±è´¥:', error);
                showToast('è¯·å…ˆä¿å­˜å›¾ç‰‡ï¼Œç„¶åæ‰‹åŠ¨åˆ†äº«');
            }
        }

        // æœ¬åœ°å­˜å‚¨
        function saveTreasures() {
            localStorage.setItem('ravens_treasures', JSON.stringify(treasures));
        }

        function loadTreasures() {
            const data = localStorage.getItem('ravens_treasures');
            treasures = data ? JSON.parse(data) : [];
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        document.getElementById('generateBtn').addEventListener('click', generateTreasure);
        
        // ä¸ºç”ŸæˆæŒ‰é’®æ·»åŠ ç«èŠ±æ•ˆæœ
        document.getElementById('generateBtn').addEventListener('click', createSparks);
        
        // ä¸ºæŠ½å–æŒ‰é’®æ·»åŠ ç«èŠ±æ•ˆæœï¼ˆä½¿ç”¨å®‰å…¨æ£€æŸ¥ï¼‰
        const drawBtn = document.getElementById('drawBtn');
        if (drawBtn) {
            drawBtn.addEventListener('click', createSparks);
        }

        init();
    </script>
</body>
</html>
